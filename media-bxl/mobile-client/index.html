<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Fix My Street</title>
        <link rel="stylesheet" type="text/css" media="screen" href="jQTouch/jqtouch/jqtouch.css"></link>
        <link rel="stylesheet" type="text/css" media="screen" href="jQTouch/themes/apple/theme.css"></link>
        <link rel="stylesheet" type="text/css" media="screen" href="css/fms-mobile.css"></link>

        <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript" charset="utf-8"></script>-->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="jQTouch/jqtouch/jqtouch.js" type="application/x-javascript" charset="utf-8"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
        <script src="http://openlayers.org/api/2.11/OpenLayers.js"></script>
		<script src="http://proj4js.org/lib/proj4js-combined.js"></script>

        <script src="../js/fixmystreetmap.js"></script>
        <script>

            var jQT = $.jQTouch({
                icon: 'icon.png',
                startupScreen: 'startup.png'
            });
			

            $(document).bind('ready',function(){
				var point = {x:0, y:0};

                /*
				$(document.body).bind('turn',function(){
                    var $container = $('#container');
                    var $toolbar = $container.prev();
                    //$map.css({top:$toolbar.offset().top + $toolbar.height()});
                    $container.css({top:45});
                });
                $('body').trigger('turn');
				*/

                if(navigator.geolocation)
				{
                    navigator.geolocation.getCurrentPosition(function(position)
					{
    
                        var source = new Proj4js.Proj("EPSG:4326");
                        var dest   = new Proj4js.Proj("EPSG:31370");
                        var p      = new Proj4js.Point(position.coords.longitude, position.coords.latitude);
                        
                        Proj4js.transform(source, dest, p);
						
						point = p;
						$('#create-report').attr('href','/mobile/reports/new?lon='+p.x+'&lat='+p.y+'&address=arts');

                        $('#map-bxl').fmsMap({
							origin:{x:p.x,y:p.y}
						});
						$('#map-bxl').fmsMap('addDraggableMarker', p.x, p.y);
                    });
                }
				$('#map-bxl').bind('markermoved',function(evt,p){
					//point = {x:p.x,y:p.y};
					$('#create-report').attr('href','/mobile/reports/new?lon='+p.x+'&lat='+p.y+'&address=arts');
				});

                $('#show-search').tap(function(evt){
                    evt.preventDefault();
                    $(this).hide();
                    $('#search-form').show();
                });
				$('#search').change(function(evt){
					evt.preventDefault();
					$(this).closest('form').append('<p>searching... (not yet implemented)</p>');
				});
				$('#search-form').submit(function(evt){
					evt.preventDefault();
				});

				$('#jqt').delegate('#id_category', 'change', function(event){
					// updates entry notes
					var el_id = $('#id_category').val();
					if(el_id)
					{
						$("#secondary_container").load("/ajax/categories/"+el_id);
					}
					else
					{
						$("#secondary_container").html('');
					}
				});

				$('#jqt').delegate('#new_report', 'pageAnimationEnd', function(event, info){
					if (info.direction == 'in')
					{
						var $form = $(this).find('form');
						
						$('#id_category').change();// initialize notes
						
						$form.find('.error-msg').remove();
						$form.find(':submit').attr('disabled','disabled');
						$('#id_address').addClass('loading');

						$('#map-bxl').fmsMap('getSelectedAddress', function(response){					
							$form.removeClass('loading');
							$form.find(':submit').removeAttr('disabled');
							
							if(response.status == 'success')
							{
								$('#id_postalcode').val(response.result.address.street.postCode);
								$('#id_address').val(response.result.address.street.name + ', ' + response.result.address.number);
							}
							else
							{
								$form.removeClass('loading');
								$('#id_address').before('<p class="error-msg">' + response.status + '</p>');
							}
						});
						
						if(navigator.device){
							navigator.device.capture.captureImage(success, error, { limit: 1 });
						}
					}
				});
            });

			/* proj4js config */
            Proj4js.defs["EPSG:31370"]="+proj=lcc +lat_1=51.16666723333334 +lat_2=49.83333389999999 +lat_0=90 +lon_0=4.367486666666666 +x_0=150000.013 +y_0=5400088.438 +ellps=intl +towgs84=-99.1,53.3,-112.5,0.419,-0.83,1.885,-1.0 +units=m +no_defs";
        </script>
    </head>
    <body>
        <div id="jqt">
            <div id="home" selected="true" class="panel">
                <div class="toolbar">
                    <h1>Fix My Street</h1>
                </div>
                <div id="container">
                    <div id="map-bxl"> </div>
					<form id="search-form">
	                    <input id="search" type="search"></input>
					</form>
                    <button id="show-search" class="grayButton">Search</button>
                    <!--<button id="confirm">Confirm</button>-->
                    <a id="create-report" class="grayButton">Confirm</a>
                </div>
            </div>
        </div>
    </body>
</html>
