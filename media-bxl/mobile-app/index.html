<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Fix My Street</title>
        <link rel="stylesheet" type="text/css" media="screen" href="jQTouch/jqtouch/jqtouch.css"></link>
        <link rel="stylesheet" type="text/css" media="screen" href="jQTouch/themes/apple/theme.css"></link>
        <link rel="stylesheet" type="text/css" media="screen" href="css/fms-mobile.css"></link>

        <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript" charset="utf-8"></script>-->
        <script src="jquery/jquery-1.4.2.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="jQTouch/jqtouch/jqtouch.js" type="application/x-javascript" charset="utf-8"></script>

		<script src="jquery/js/jquery-ui-1.8.16.custom.min.js"></script>
        <script src="OpenLayers-2.11/OpenLayers.js"></script>
        <script src="fixmystreetmap.js"></script>
		<script type="text/javascript" charset="utf-8" src="phonegap-1.1.0.js"></script>

		<script src="proj4js/lib/proj4js-combined.js"></script>


        <script>
            var jQT = $.jQTouch({
				/*debug: true,*/
                icon: 'icon.png',
                startupScreen: 'startup.png'
            });
			

            $(document).bind('ready',function(){
				var $map = $('#map-bxl');
				var rootUrl = "http://192.168.103.27:8000";

                /*
				$(document.body).bind('turn',function(){
                    var $container = $('#container');
                    var $toolbar = $container.prev();
                    //$map.css({top:$toolbar.offset().top + $toolbar.height()});
                    $container.css({top:45});
                });
                $('body').trigger('turn');
				*/

                if(navigator.geolocation && navigator.geolocation.getCurrentPosition)
				{
                    navigator.geolocation.getCurrentPosition(function(position)
					{
                        var source = new Proj4js.Proj("EPSG:4326");
                        var dest   = new Proj4js.Proj("EPSG:31370");
                        var p      = new Proj4js.Point(position.coords.longitude, position.coords.latitude);
                        
                        Proj4js.transform(source, dest, p);
						
						$('#create-report').attr('href',rootUrl + '/mobile/reports/new?lon='+p.x+'&lat='+p.y+'&address=arts');

                        $map.fmsMap({
							apiRootUrl: rootUrl + "/api/",
							origin:{x:p.x,y:p.y},
							markerStyle:{
								externalGraphic: "images/marker.png",
								graphicXOffset:-32/2,
								graphicYOffset:-32,
								graphicHeight:32,
								graphicWidth:32
							},
							fixedMarkerStyle:{
								externalGraphic: rootUrl + "/media/images/marker-fixed.png"
							},
							pendingMarkerStyle:{
								externalGraphic: rootUrl + "/media/images/marker-pending.png"
							}
						});
						
						$.getJSON(rootUrl + '/api/reports/',{lon:p.x,lat:p.y},function(response){
							if(response.status != 'success')
							{
								// do something
								console.log('error');
								return ;
							}

							for(var i in response.results)
							{
								var report = response.results[i];
								$map.fmsMap('addReport',report);
							}
							$map.fmsMap('addDraggableMarker', p.x, p.y);
						});
                    },
					function(){
						$map.prepend('Your device do not support geo localisation..');
                        $map.fmsMap({
							apiRootUrl: rootUrl + "/api/",
							markerStyle:{
								externalGraphic: "images/marker.png",
								graphicXOffset:-32/2,
								graphicYOffset:-32,
								graphicHeight:32,
								graphicWidth:32
							}
						});
					});
                }

				$map.bind('markermoved',function(evt,p){
					$('#create-report').attr('href',rootUrl + '/mobile/reports/new?lon='+p.x+'&lat='+p.y+'&address=arts');
				});

				$map.bind('reportselected',function(evt, point, report){
					$.get(rootUrl + '/mobile/reports/' + report.id,function(response){
						var $panel = $(response);
						var id = $panel[0].id;
						$('#jqt').append($panel);
						console.log($panel);
						$panel.hide();
						jQT.goTo('#' + id);//, 'slide');
					});
				});

				$('#jqt').delegate('#id_category', 'change', function(event){
					// updates entry notes
					var el_id = $('#id_category').val();
					if(el_id)
					{
						$("#secondary_container").load(rootUrl + "/ajax/categories/"+el_id);
					}
					else
					{
						$("#secondary_container").html('');
					}
				});

				$('#jqt').delegate('.new_report', 'pageAnimationEnd', function(event, info){
					if (info.direction == 'in')
					{
						var $form = $(this).find('form');
						
						$('#id_category').change();// initialize notes
						
						$form.find('.error-msg').remove();
						$form.find(':submit').attr('disabled','disabled');
						$('#id_address').addClass('loading');

						$map.fmsMap('getSelectedAddress', function(response){					
							$form.removeClass('loading');
							$form.find(':submit').removeAttr('disabled');
							
							if(response.status == 'success')
							{
								$('#id_postalcode').val(response.result.address.street.postCode);
								$('#id_address').val(response.result.address.street.name + ', ' + response.result.address.number);
							}
							else
							{
								$form.removeClass('loading');
								$('#id_address').after('<p class="error-msg">' + response.status + '</p>');
							}
						});
						
						$form.find('#id_photo').closest('p').hide();
						
						function setPhotoPath(fileURI)
						{
							$form.find('#id_photo').val(fileURI);
							$form.find('#photo_preview').attr('src',fileURI).fadeIn();
						}
						
						/*
						if(navigator.device && navigator.device.capture && navigator.device.capture.captureImage)
						{
							navigator.device.capture.captureImage(setPhotoPath,
							function(){
								alert('Failed to take photo...');
							}, { limit: 1 }); 
						}
						else
						{
							alert('navigator.device.capture.captureImage not available');
						}
						*/
						
						if(navigator.camera && navigator.camera.getPicture)
						{
							//alert('Open the camera...');
							navigator.camera.getPicture(setPhotoPath, function(message)
							{
								alert('Failed to take photo... ' + message);
							},{ 
								quality: 50/*, 
								destinationType: Camera.DestinationType.FILE_URI*/
							}); 
						}
						else
						{
							alert('navigator.camera.getPicture not available');
						}
						
					}
				});

			
				var $searchTerm = $('#search');
				var $searchWard = $('#search-ward');
				var $searchForm = $('#search-form');
				var $proposal = $('#proposal');

                $('#show-search').click(function(evt){
                    evt.preventDefault();
                    $(this).hide();
                    $searchForm.show();
                });

				$searchForm.submit(function(event)
				{
					event.preventDefault();
					
					$proposal.slideUp();
					$searchTerm.addClass('loading');
					
					$.ajax({
						url:rootUrl + '/api/search/',
						type:'POST',
						contentType:'text/json',
						dataType:'json',
						data:JSON.stringify({
							"language": "fr",
							"address": {
								"street": {
									"name": $searchTerm.val(),
									"postcode": $searchWard.val() || ''
								},
								"number": ""
							}
						}),
						success:function(response){
							if(response.status == 'success' && response.result.length > 0)
							{
								if(response.result.length == 1)
								{
									window.location.assign(resToHref(response.result[0]));
								}
								else
								{
									$searchTerm.removeClass('loading');
									$proposal.empty();
									for(var i in response.result)
									{
										var loc = response.result[i];
										var street = loc.address.street;
										$street = $('<li>' + street.name + ' (' + street.postCode + ')</li>')
											.data('loc',loc)
											.click(function()
											{
												var loc = $(this).data('loc');
												$map.fmsMap('setCenter',loc.point.x, loc.point.y);
												
												$searchForm.hide();
												$('#show-search').show();
											});
										$proposal.append($street);
									}
									$proposal.slideDown();
								}
								// window.location.assign('/reports/new?lon=' + response.result.point.x + '&lat=' + response.result.point.y);
							}
							else
							{
								$searchTerm.removeClass('loading');
								if(response.status == "noresult" || response.status == "success")
								{
									$proposal.html('<p class="error-msg">No corresponding address has been found</p>').slideDown();
								}
								else
								{
									$proposal.html('<p class="error-msg">' + response.status + '</p>').slideDown();
								}
							}
						},
						error:function(){
							$searchTerm.removeClass('loading');
					
							$proposal.html('<p class="error-msg">Unexpected error.</p>');
						}
					});
				});
				/*
				if(navigator.camera && navigator.camera.getPicture);
					navigator.camera.getPicture(function(){
					});
				}
				*/
            });

			/* proj4js config */
            Proj4js.defs["EPSG:31370"]="+proj=lcc +lat_1=51.16666723333334 +lat_2=49.83333389999999 +lat_0=90 +lon_0=4.367486666666666 +x_0=150000.013 +y_0=5400088.438 +ellps=intl +towgs84=-99.1,53.3,-112.5,0.419,-0.83,1.885,-1.0 +units=m +no_defs";
        </script>
    </head>
    <body>
        <div id="jqt">
            <div id="home" selected="true" class="panel">
                <div class="toolbar">
                    <h1>Fix My Street</h1>
                </div>
                <div id="container">
                    <div id="map-bxl"> </div>
					<form id="search-form">
	                    <input id="search" type="search"></input>
						<ul id="proposal" style="display:none;"> </ul>
					</form>
                    <button id="show-search" class="grayButton">Search</button>
                    <!--<button id="confirm">Confirm</button>-->
                    <a id="create-report" class="grayButton">Confirm</a>
                </div>
            </div>
        </div>
    </body>
</html>
