{% extends "base.html" %}
{% load i18n %}
{% load tags %}
{% block title %}{% trans "New Report" %}{% endblock %}
{% block script %}
<script src="{{MEDIA_URL}}hashchange/jquery.ba-hashchange.min.js"></script>

{% map_scripts %}
<script>

$(document).ready(function() {
	var $form = $('#report_form');
	var $map = $('#map-bxl');
	
	$map.fmsMap({
		apiLang:'{{ LANGUAGE_CODE }}',
		origin:{
			x:{{ pnt.x }},
			y:{{ pnt.y }} 
		}
	});
	{% for report in reports %}
	$map.fmsMap('addReport', {% report_to_json report %},{{forloop.counter}});
	{% endfor %}
	$map.fmsMap('addDraggableMarker',{{ pnt.x }}, {{ pnt.y }});

	
	$(window).hashchange(function(){
		if(window.location.hash == '#form')
		{
			$form.show();
			$('#nearby-reports,#instructable').hide();
			$('#back').show();
			retrieveAddress();
		}
		else if(window.location.href.indexOf('new') < 0)
		{
			$form.show();
			$('#nearby-reports,#instructable,#back').hide();
			$('#back').show();
		}
		else
		{
			$form.hide();
			$('#nearby-reports').show();
			$('#back').hide();
		}
	});
	$(window).hashchange();

	$('#id_category').change(function(evt) {
		// updates entry notes
		var el_id = $('#id_category').val();
		if(el_id)
		{
			$("#secondary_container").load("/ajax/categories/" + el_id);
		}
		else
		{
			$("#secondary_container").html('');
		}
	});
	$('#id_category').change();// initialize notes
	
	$map.bind('markerdrag click movestart zoomend',function(evt,point){
		$('#instructable').hide();	
	});

	$map.bind('markermoved',function(evt,point){
		$('#id_lon').val(point.x);
		$('#id_lat').val(point.y);
		
		if(window.location.hash != '#form')
		{
			window.location.assign('#form');
			return; // address is retrieved when form is shown
		}
		
		retrieveAddress();
	});

	$map.bind('reportselected',function(evt, point, report){
		window.location.assign('/reports/' + report.id);
	});

	function retrieveAddress()
	{
		$form.find('.error-msg').remove();
		$form.find(':submit').prop('disabled',true);
		$('#id_address').addClass('loading');

		$map.fmsMap('getSelectedAddress',function(response)
		{
			$form.find(':submit').prop('disabled',false);
			$('#id_address').removeClass('loading');
			
			if(response.status == 'success')
			{
				$('#id_postalcode').val(response.result.address.street.postCode);
				$('#id_address').val(response.result.address.street.name + ', ' + response.result.address.number);
			}
			else
			{
				var msg = 'Error: ' + response.status;
				if(response.status == 'error')
				{
					msg = 'Unable to locate this address';
				}
				$('#id_address').removeClass('loading');
				$form.find(':submit').prop('disabled',false);
				$('#id_address').after('<p class="error-msg">' + msg + '</p>');
			}
		});
	}

	/*
	// in the case of grafity category, we ask Is it Hate Graffiti.
	// it is disabled see templates-bxl/ajax/category_description.html
	if($('input[name=is_hate]:checked').val() == 'yes') {
		$('.ishate').show();
	}

	$('.radiohate').live('click', function(event) {
		if($(this)[0].value =='yes') {
			$('.ishate').show('slow');
			// disable fields
			$('.hideonhate').hide();
			$('#submit_report_button').enabled = false;
	
		} else {
			$('.ishate').hide();
			$('.hideonhate').show();
			$('#submit_report_button').enabled = true;
		}
	});
	*/

});
</script>
{% endblock %}

{% block content %}
<div id="page_content_container">
	<div id="leftcol">
		<h1>{% trans "Submitting a report" %}</h1>
		<div id="nearby-reports">
			<div id='report-destination'>
				<h2>
					{% trans "Nearby reports" %} 
				</h2>
				
				{% if reports %}
					<div id='search_results'>
					{% for report in reports %}
						<a href="{{report.get_absolute_url}}" class="report">
							<img src="{{MEDIA_URL}}images/marker/{% if report.is_fixed %}green{% else %}red{% endif %}/marker{{ forloop.counter }}.png" class="report-counter"/>
							{% if report.photo %}
							<img src="{{MEDIA_URL}}photos/photo_{{ report.id }}.thumbnail.jpeg" class="report-preview"/>
							{% endif %}
							<h3 class="report-title"> {{report.title}} ({{report.distance.km|floatformat:2}} km)</h3>
							<p class="report-address">{{report.address}}</p>
							{% if report.is_fixed %}({% trans "fixed" %}){% endif %}
						</a>
					{% endfor %}
					</div>
				{% else %}
					<p>{% trans "No problems have been reported in this area." %}</p>
				{% endif %}
				</ol>
			</div>
		</div>
	
		<form enctype="multipart/form-data" method="post" action="/reports/" id='report_form' style="display:none;">
			<table class='form'>
				{{ report_form.as_table }}
				<tr>
					<th></th>
					<td id="photo_note">{% trans "* Optional" %}</td>
				</tr>
				<tr>
					<td></td>
					<td><div id='secondary_container'></div></td>
				</tr>
				{{ update_form.as_table }}
				<tr>
					<td></td>
					<td>
						<div class='note'>
							<p><strong>{% trans "Please Note" %} :</strong></p>
							<ul>
								<li>{% trans "Please be polite, concise and to the point." %}</li>
								<li>{% trans "Please do not be abusive - abusing the service devalues the service for all users." %}</li>
								<li>{% trans "Writing your message entirely in block capitals makes it hard to read, as does a lack of punctuation." %}</li>
								<li>{% trans "Remember that FixMyStreet is primarily for reporting physical problems that can be fixed. If your problem is not appropriate for submission via this site please contact city officials directly." %}</li>
							</ul>
							<p/>
						</div>
					</td>
				</tr>
				<tr>
					<td></td>
					<td align="right"><input type="submit" class='big_button' value="{% trans "Submit" %}" /></td>
				</tr>
			</table>
		</form>
	</div>
	<div id="rightcol">
		<div id="map-bxl">
			<div id="instructable">
				<h3>{% trans "To fill a new report" %}</h3>
				<p>
					{% trans "Drag me to the correct location on the map." %}
				</p>
			</div>
		</div>
		<h3>{% trans "Zoom out to see more reports nearby." %}</h3>
		<a id="back" href="#">{% trans "Review reports" %}</a>
	</div>
</div>
{% endblock %}