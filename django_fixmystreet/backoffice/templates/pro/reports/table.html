{% extends "base.html" %}
{% load i18n tags %}

{% block script_map %}
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ STATIC_URL }}lib/dataTables/css/jquery.dataTables.css"></link>
<link rel="stylesheet" href="{{ STATIC_URL }}css/table.css"></link>
{{ block.super }}
{% endblock %}

{% block script %}
{{ block.super }}
<script src="{{ STATIC_URL}}js/search.js"></script>
<script src="{{ STATIC_URL }}lib/dataTables/js/jquery.dataTables.js"></script>
<script src="{{ STATIC_URL }}lib/dataTables-columnFilter/js/jquery.dataTables.columnFilter.js"></script>

{% block script-search %}
  <script type="text/javascript">
    var NEXT_PAGE_URL = '{% url "report_verify_pro" %}';
    $(function(){
      {% if popup_reports%}
      $("#report_popup").modal();
      {% endif %}
    });

    var zipcodes = new Object();

    {% for zip in zipcodes %}
        zipcodes[{{zip.code}}] = new Object();
        zipcodes[{{zip.code}}].participation = {{ zip.commune.active|yesno:"true,false" }};
        zipcodes[{{zip.code}}].phone = " {{zip.commune.phone}} ";
        zipcodes[{{zip.code}}].commune = "{{zip.commune.name}}";
    {% endfor %}

  </script>
{% endblock %}

<script>

var table;


jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "date-euro-pre": function ( a ) {
        if ($.trim(a) != '') {
            var datea = $.trim(a).split('/');
            var x = parseInt(datea[2] + datea[1] + datea[0]);
        } else {
            var x = 0;
        }

        return x;
    },

    "date-euro-asc": function ( a, b ) {
        return a - b;
    },

    "date-euro-desc": function ( a, b ) {
        return b - a;
    }
});

var columns = [
    {type: "number"}, // incident number
    {type: "image", "bSortable": false},   // thumbnail (image type is considered as text)
    {sType: "date-euro", oSort:"date-eu"}, // date accepted
    {type: "select"}, // categories
    {type: "select"}, // sec categories
    {type: "text"},   // addr
    {type: "select"}, // postal code
    {type: "select", values: [
        '{{ True|yesno:_("regional,communal") }}',
        '{{ False|yesno:_("regional,communal") }}'
    ]}, // regional
    {type: "select", values: [ // status
        {% for s in 'Report'|model_field_choices:'status' %}
            "{{ s }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]},
    {type: "select"}, // resp entity
    {type: "select"}, // resp manager
    {type: "select"}, // contractor
    {type: "select", values: [
        '{{ True|yesno:_("planned,not planned") }}',
        '{{ False|yesno:_("planned,not planned") }}'
    ]}, // planned
    {sType: "date-euro", oSort:"date-eu"}, // date planned
    {type: "number"}, // priority
    {type: "select", values: [
        '{{ True|yesno:_("subscribed,not subscribed") }}',
        '{{ False|yesno:_("subscribed,not subscribed") }}'
    ]}, // subscribed
    {type: "select", values: [
        '{{ True|yesno:_("yes,no") }}',
        '{{ False|yesno:_("yes,no") }}'
    ], selected: '{{ False|yesno:_("yes,no") }}'}, // pending
    {type: "null", bSearchable: false, bSortable: false, bVisible: false}, // point.x
    {type: "null", bSearchable: false, bSortable: false, bVisible: false}, // point.y
    {type: "null", bSearchable: false, bSortable: false, bVisible: false}, // status
]

// Get table rendered by django
function generateTableContent() {
    document.getElementById('table-container').innerHTML = '<div id="table-loading" class="span12"><img src="{{ STATIC_URL }}/images/spinner.gif" /></div>';

    $.ajax({
        url: "{% url 'report_table_content_pro' %}",
        data: "",
        dataType: "html",
        success: function(data) {
            $('#map-loading').hide();

            //Retrieve the last used preferences
            var sortPreferences = fms.restoreTablePreferences();
            //Default sort by ID desc (first column) when not yet available
            var sortPreferenceIndex = 
                (sortPreferences !== null && sortPreferences.sort !== null)?sortPreferences.sort.idx:0;
            var sortPreferenceValue = 
                (sortPreferences !== null && sortPreferences.sort !== null)?sortPreferences.sort.sortType:'desc';
            var sortPreferenceUnselectedColumns = 
                (sortPreferences !== null && sortPreferences.unselectedColumn !== null)?sortPreferences.unselectedColumn:[];

            document.getElementById('table-container').innerHTML = data;

            // Init table
            //Method table.oApi._fnColumnIndexToVisible could be useful to match the datacolumn to visible one about indexes
            table = $('#result-table').dataTable({
                aoColumns: columns,
                // sScrollX: "100%",
                // bScrollCollapse: true
                "aaSorting": [[ sortPreferenceIndex, sortPreferenceValue ]],

                "rawCallback": function() {
                    fms.storeTablePreferences({'sort':this.fnSettings().aaSorting});
                },
                "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
                    //If image then display using img tag 
                    if (this.fnSettings().aoColumns[1].bVisible === true && this.fnSettings().aoColumns[1].type === 'image') {
                        var imageIndex = 0 + (this.fnSettings().aoColumns[0].bVisible === true?1:0);
                        $('td:eq('+imageIndex +')', nRow).html( '<a><img src="' + aData[1] + '" /></a>' );
                    }
                    return nRow;
                 }
            });
            
            //Generate filters FIRST
            table.columnFilter({ sPlaceHolder: "head:after", aoColumns: columns});
            
            //And THEN show/hide columns
            var checkboxes = $('#column-visibility :checkbox');
            //Show, Hide columns based on user selection
            for (var cptColumnVisiblity in sortPreferenceUnselectedColumns) {
                console.log('restore column visibility');
                table.fnSetColumnVis(cptColumnVisiblity, !sortPreferenceUnselectedColumns[cptColumnVisiblity]);
                if (sortPreferenceUnselectedColumns[cptColumnVisiblity]) {
                    $(checkboxes[cptColumnVisiblity]).attr('checked',null); 
                }
            }

            // Bind event : refresh markers on map when table sort and filter
            table.bind('filter', refreshMap);

            table.delegate('tr', 'click', function () {
                var href = $(this).data('href');
                if(href) {
                    window.open(href);
                }
            });

           

            //Event implementation for checkbox value change
            $('#column-visibility :checkbox').change(function () {
                //Store column selection
                var sortPreferences = fms.restoreTablePreferences();
                var sortPreferenceUnselectedColumns;

                if (sortPreferences !== null && sortPreferences.unselectedColumn !== null) {
                        sortPreferenceUnselectedColumns = sortPreferences.unselectedColumn;
                } else {
                        sortPreferenceUnselectedColumns = {};
                }

                var checked = $(this).prop('checked');
                var index = $(this).closest('li').index(); // show column

                //Remove Item
                sortPreferenceUnselectedColumns[index] = !checked;
                fms.storeTablePreferences({'unselectedColumn':sortPreferenceUnselectedColumns});

                table.fnSetColumnVis(index, checked);
            });//.change();

            // Init map markers
            refreshMap();
        }
    });
}

/*function customFnRowCallback( nRow, aData, iDisplayIndex )
 {
    //If image then display it as is.
    
    $('td:eq('+iDisplayIndex+')', nRow).html( '<a><img src="' + aData[1] + '" /></a>' );
    return nRow;
 }*/

generateTableContent();

// Refresh table
var refreshTable = document.getElementById('refreshTable');
refreshTable.addEventListener('click', function() {
    //Show loading icon
    $('#map-loading').show();

    // Destroy current table
    table.fnDestroy(true);
    // Regenerate table
    generateTableContent();
});

// Show or hide filters in modal
var showHideFilters = document.getElementById('showHideFilters');
var tableFilters    = document.getElementById('table-filters');

showHideFilters.addEventListener('click', function() {
    tableFilters.classList.toggle('table-filters-show');
});

// Refresh markers on map when table sorting/filtering
function refreshMap() {
    // Get all row according to filter
    var data = table._('tr', {"filter": "applied"});

    // For each row, build a report marker
    var markers = [];
    for (var i in data) {
        report = data[i];
        //console.log(data[i]);
        markers.push({
            id: report[0],
            status: parseInt(report[report.length - 1]),
            point: {
                x: report[report.length-3],
                y: report[report.length-2]
            }
        });
    }
    fms.currentMap.addReportCollection(markers);
}

// Load map
(function() {
    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    WMS_SERVICE_URL
    });
    fms.currentMap.map.addControl(
        new OpenLayers.Control.LayerSwitcher({
            'div':OpenLayers.Util.getElement('layerswitcher')
        })
    );
})(document);

</script>
{% endblock %}

{% block map %}
<div class="row">
    <div class="span12">
        <p class="switch_verify btn-group">
            <a href="#modalTable" id="tableSwitch" role="button" class="btn" data-toggle="modal">{% trans "Table" %}</a>
            <a class="btn active" id="btn-map">{% trans "Map" %}</a>
        </p>
    </div>
</div>

<div class="row">

    {% include "_page_header.html" with map=True search_report=True search_address=True classes="map-big" loader=True %}
</div>
{% endblock %}

{% block content %}
<div id="modalTable" class="modal hide fade" style="width: 98%; left: 10px; margin-left: 0px">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Table</h3>
    </div>

    <div class="modal-body">

        <button id="showHideFilters">Edit columns</button>
        <button id="refreshTable">Refresh table</button>
        <div id="table-filters" class="table-filters">
            <ul id="column-visibility">
                <li><label><input type="checkbox" checked /> {% trans "Ticket" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Thumbnail" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Created at" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Category" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Sub category" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Address" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Postal code" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Road type" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Status" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Responsible" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Responsible department" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Assigned contractor" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Planning" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Planning date" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Priority" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Subscribed" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Pending" %}</label></li>
            </ul>
        </div>

        <div id="table-container"></div>
    </div>

    <div class="modal-footer">
        <input type="button" class="btn"  value="{% trans 'Close'%}" data-dismiss="modal" aria-hidden="true"/>
    </div>
</div>
{% endblock %}
