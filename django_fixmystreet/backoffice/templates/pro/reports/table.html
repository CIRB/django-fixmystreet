{% extends "base.html" %}
{% load i18n tags %}

{% block script_map %}
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ STATIC_URL }}lib/dataTables/css/jquery.dataTables.css"></link>
<link rel="stylesheet" href="{{ STATIC_URL }}css/table.css"></link>
{{ block.super }}
{% endblock %}

{% block script %}
{{ block.super }}
<script src="{{ STATIC_URL}}js/search.js"></script>
<script src="{{ STATIC_URL }}lib/dataTables/js/jquery.dataTables.js"></script>
<script src="{{ STATIC_URL }}lib/dataTables-columnFilter/js/jquery.dataTables.columnFilter.js"></script>
<script>

var table;


jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "date-euro-pre": function ( a ) {
        if ($.trim(a) != '') {
            var datea = $.trim(a).split('/');
            var x = parseInt(datea[2] + datea[1] + datea[0]);
        } else {
            var x = 0;
        }

        return x;
    },

    "date-euro-asc": function ( a, b ) {
        return a - b;
    },

    "date-euro-desc": function ( a, b ) {
        return b - a;
    }
});

var columns = [
    {type: "null", bSortable: false},
    {type: "number"}, // incidnet number
    {type: "select"}, // categories
    {type: "select"}, // sec categories
    {type: "text"}, // addr
    {type: "select"}, // postal code
    {type: "select", values: [
        '{{ True|yesno:_("regional,communal") }}',
        '{{ False|yesno:_("regional,communal") }}'
    ]}, // regional
    {type: "select", values: [ // status
        {% for s in 'Report'|model_field_choices:'status' %}
            "{{ s }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]},
    {type: "select"}, // resp entity
    {type: "select"}, // resp manager
    {type: "select", values: [
        '{{ True|yesno:_("planned,not planned") }}',
        '{{ False|yesno:_("planned,not planned") }}'
    ]}, // planned
    {sType: "date-euro", oSort:"date-eu"}, // date planned
    {type: "number"}, // priority
    {type: "select", values: [
        '{{ True|yesno:_("subscribed,not subscribed") }}',
        '{{ False|yesno:_("subscribed,not subscribed") }}'
    ]}, // subscribed
    {type: "select", values: [
        '{{ True|yesno:_("yes,no") }}',
        '{{ False|yesno:_("yes,no") }}'
    ]}, // pending
    {type: "null", bSearchable: false, bSortable: false, bVisible: false}, // point.x
    {type: "null", bSearchable: false, bSortable: false, bVisible: false}, // point.y
    {type: "null", bSearchable: false, bSortable: false, bVisible: false}, // status
]

// Get tbody content rendered by django
$.ajax({
    url: "{% url 'report_table_content_pro' %}",
    data: "",
    dataType: "html",
    success: function(data) {
        document.querySelector('tbody').innerHTML = data;

        // Init table
        table = $('#result-table').dataTable({aoColumns: columns});
        // {
        //     "bStateSave": true
        // });

        // Bind event : refresh markers on map when table sort and filter
        table.bind('filter', refreshMap);

        table.columnFilter({ sPlaceHolder: "head:after", aoColumns: columns});

        $('#column-visibility :checkbox').change(function () {
            var checked = $(this).prop('checked'),
                index = $(this).closest('li').index() + 1; // show column
            table.fnSetColumnVis(index, checked);
        }).change();

        // Init map markers
        refreshMap();
    }
});

// Show or hide filters in modal
var showHideFilters = document.getElementById('showHideFilters');
var tableFilters    = document.getElementById('table-filters');

showHideFilters.addEventListener('click', function() {
    tableFilters.classList.toggle('table-filters-show');
});

// Refresh markers on map when table sorting/filtering
function refreshMap() {
    // Clean features
    if(fms.currentMap.markersLayer) {
        fms.currentMap.markersLayer.destroyFeatures();
    }

    // Get all row according to filter
    var data = table._('tr', {"filter":"applied"});

    // For each row, build a report marker
    var markers = [];
    for (var i=0, dataLength=data.length; i<dataLength; i++) {
        //console.log(data[i]);

        var report   = {};

        report.point = {};
        report.point["x"] = data[i][15];
        report.point["y"] = data[i][16];

        report.id = data[i][1];
        report.status = data[i][17];

        markers.push(fms.currentMap.addReport(report, i, false));
    }
    fms.currentMap.markersLayer.addFeatures(markers);
}

// Load map
(function() {
    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    WMS_SERVICE_URL
    });
})(document);

</script>
{% endblock %}

{% block map %}
<div class="row">
    <div class="span12">
        <p class="switch_verify btn-group">
            <a href="#modalTable" id="tableSwitch" role="button" class="btn" data-toggle="modal">{% trans "Table" %}</a>
            <a class="btn active" id="btn-map">{% trans "Map" %}</a>
        </p>
    </div>
</div>

<div class="row">
    {% include "_map_search.html" with search_report=True %}
</div>
{% endblock %}

{% block content %}
<div id="modalTable" class="modal hide fade" style="width: 95%; left: 20%;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Table</h3>
    </div>

    <div class="modal-body">

        <button id="showHideFilters">Edit columns</button>
        <div id="table-filters" class="table-filters">
            <ul id="column-visibility">
                <li><label><input type="checkbox" checked /> {% trans "Ticket" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Category" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Sub category" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Address" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Postal code" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Road type" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Status" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Responsible" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Responsible department" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Planning" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Planning date" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Priority" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Subscribed" %}</label></li>
                <li><label><input type="checkbox" checked /> {% trans "Pending" %}</label></li>
            </ul>
        </div>

        <table id="result-table" class="dataTable">
            <thead>
                <tr>
                    <th></th>
                    <th>{% trans "All" context "Ticket" %}</th>
                    <th>{% trans "All" context "Categories" %}</th>
                    <th>{% trans "All" context "Sub categories" %}</th>
                    <th>{% trans "All" context "Address" %}</th>
                    <th>{% trans "All" context "Postal code" %}</th>
                    <th>{% trans "All" context "Road type" %}</th>
                    <th>{% trans "All" context "Status" %}</th>
                    <th>{% trans "All" context "Responsible entity" %}</th>
                    <th>{% trans "All" context "Responsible department" %}</th>
                    <th>{% trans "All" context "Planning" %}</th>
                    <th>{% trans "All" context "Planning date" %}</th>
                    <th>{% trans "All" context "Priority" %}</th>
                    <th>{% trans "All" context "Subscribed" %}</th>
                    <th>{% trans "All" context "Pending" %}</th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
                <tr>
                    <th></th>
                    <th>{% trans "Ticket" %}</th>
                    <th>{% trans "Category" %}</th>
                    <th>{% trans "Sub category" %}</th>
                    <th>{% trans "Address" %}</th>
                    <th>{% trans "Postal code" %}</th>
                    <th>{% trans "Road type" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th>{% trans "Responsible entity" %}</th>
                    <th>{% trans "Responsible department" %}</th>
                    <th>{% trans "Planning" %}</th>
                    <th>{% trans "Planning date" %}</th>
                    <th>{% trans "Priority" %}</th>
                    <th>{% trans "Subscribe" %}</th>
                    <th>{% trans "Pending" %}</th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <div class="modal-footer">
        <input type="button" class="btn"  value="{% trans 'Close'%}" data-dismiss="modal" aria-hidden="true"/>
    </div>
</div>
{% endblock %}
