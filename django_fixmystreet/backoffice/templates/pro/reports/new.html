{% extends "reports/new.html" %}
{% load i18n %}
{% load tags %}
{% block title %}{% trans "New Report" %}{% endblock %}
{% block script %}
{{ block.super }}
{% block specific_scripts %}
<script>
$(document).delegate("form", "submit", function(evt) {
	if ($('#available_zipcodes option[value="'+$('#id_postalcode').val()+'"]').length == 0) {
		//This commune does not participate to fixmystreet until now.
		alert("{% trans 'This_commune_does_not_participate' %}: "+$('#available_zipcodes_as_string').html());
		return false;
	}
});
$(document).ready(function() {
$("#addFileDiv").show();
$("#addCommmentDiv").show();
$("#fileForm #id_file").attr("onchange","fileSelected();");
$('#id_category').change(function(evt) {
		// updates entry notes
		var el_id = $('#id_category').val();
		var refSecondary = $("#id_secondary_category");
		if(el_id)
                {
                        refSecondary.find("option:eq(0)").attr("selected", "selected");
                        refSecondary.removeAttr("disabled");
                        $("#secondary_container").load("/ajax/categories/" + el_id);
                        <!-- FILTER SECOND DROPDOWN -->

                        refSecondary.html('');
                        refSecondary.html($('#id_secondary_category_copy').html());
                        //Keep the first element in memory (the headlabel)
                        var headLabelOption = refSecondary.find("option:first");
			refSecondary.find("option[family!='"+el_id+"']").remove();
			//Prepend the headlabel again.
                        refSecondary.prepend(headLabelOption);
			$('#id_secondary_category').change();//copy value to hidden dropdown 
                }
                else
                {
                        refSecondary.find("option:eq(0)").attr("selected", "selected");
                        $("#secondary_container").html('');
                        refSecondary.attr('disabled', 'disabled');
                }
	});
	$('#id_category').change();// initialize notes
	
	$('#id_secondary_category').change(function(evt) {
		//Copy is necessary to avoid django validation problem	
		var el_id_copy = $('#id_secondary_category').val();
		$('#id_secondary_category_copy').val(el_id_copy);
	});
});
</script>
{% endblock %}
{% endblock %}

{% block content %}
		{{block.super}}
		{% block report_form %}
		<form enctype="multipart/form-data" method="post" action="" id='report_form' style="display:none;">
			<h2>
				{% trans "Fill the report" %} 
			</h2>
			<table class='form'>
				<tr>
					<th></th>
					<td id="required_note">{% trans "* This fields are required" %}</td>
				</tr>
				{{ report_form.as_table }}
				<tr>
					<td></td>
					<td><div id='secondary_container'></div></td>
				</tr>
				<tr>
					<td>
						<select id="available_zipcodes" style="display:none">
							{% for zip in available_zips %}
							<option value="{{zip.code}}">
							</option>
							{% endfor %}
						</select>
						<span id="available_zipcodes_as_string" style="display:none">
							{% for zip in available_zips %}
							{{zip.code}}/{{zip.name}}
							{% endfor %}
						</span>
					</td>
				</tr>
				<tr>
					<td></td>
					<td align="right">
						<p>
							<input type="submit" class='big_button' value="{% trans 'Submit' %}" />
						</p>

					</td>
				</tr>
			</table>
		</form>
		{% endblock %}
		
{% endblock %}
