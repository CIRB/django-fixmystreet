{% extends "reports/list.html" %}
{% load i18n tags %}
{% block title %}{% blocktrans %}{{status}} Reports{%endblocktrans%}{% endblock %}
{% block script %}
{{ block.super }}
<script>

var pageNumber = {{ page_number }},
    status = "{{ status }}";

$(document).ready(function() {
    var $form = $('#report_form');
    /*Hide the edition form*/
    $('#report_form').hide();
    $('#nearby-reports').show();

    //Add onclick event for arrows
    $(".pagination_next.active").click(function(evt) {
        evt.preventDefault();
        getUrlForPageNumber(pageNumber + 1);
    });
    $(".pagination_prev.active").click(function(evt) {
        evt.preventDefault();
        getUrlForPageNumber(pageNumber - 1);
    });
    $(".pagination").delegate("a:not(.active)", "click", function(evt) {
        evt.preventDefault();
        var page = $(this).data("page");
        if(page) {
            getUrlForPageNumber(page);
        }
    });


    /**
     * Method used to filter report on list
     */
    $('#search-by-address').submit(function applyFilterReports(evt) {
        evt.preventDefault();
        $("#search_by_commune_or_address_section_results").hide();
        $("#search_by_commune_or_address_section_distance").hide();
        var selectedFilterElements = $('#proposal').find('a.selected');
        if (selectedFilterElements.length > 0) {
            var valueX = $(selectedFilterElements).attr('x');
            var valueY = $(selectedFilterElements).attr('y');
            var valueStreet = $(selectedFilterElements).attr('street');
            var valueStreetNumber = $(selectedFilterElements).attr('streetNumber');
            var valueRayon = $('#rayon').val();
            var rayonChecked = valueRayon != "";
            if (rayonChecked) {
                window.location="{% url report_filter_list_pro %}?x="+valueX+"&y="+valueY+"&street="+valueStreet+"&streetNumber="+valueStreetNumber+"&rayon="+valueRayon+"&page=1";
            } else {
                window.location="{% url report_filter_list_pro %}?x="+valueX+"&y="+valueY+"&street="+valueStreet+"&streetNumber="+valueStreetNumber+"&page=1";
            }
        }
    });

    $('#search-street').submit(function filterReports(evt) {
        evt.preventDefault();
        //Hide distance section
        $("#search-by-address").hide();

        //Do not search when field is empty
        searchValue = $('#input-commune-search').val();
        if (searchValue == "") return false;

        var proposal = $('#proposal');
        $(proposal).children().remove();
        $("#search_by_commune_or_address_section_results").show();
        wardValue = $('#input-ward').val();
        if (!searchValue) { return; }
        $.ajax({
           url: URBIS_URL + 'service/urbis/Rest/Localize/getaddressesfields',
           dataType:'jsonp',
           data:{
              json:'{"language": "' + LANGUAGE_CODE + '",' +
                      '"address": {' +
                         '"street": {' +
                             '"name": "' + searchValue.replace("\"","\\\"") + '",' +
                             '"postcode": "' + wardValue.replace("\"","\\\"") + '"' +
                           '},"number": ""' +
                      '}}'
           }
        }).success(function(response) {
            if(response.status == 'success' && response.result.length > 0) {
                $(proposal).empty();
                var counter = 0;
                for(var i in response.result) {
                    var street = response.result[i].address.street;
                    var streetNumber = response.result[i].address.number;
                    var pos = response.result[i].point;
                    //$('<a class="street button" href="' + NEXT_PAGE_URL + '?x=' + pos.x + '&y=' + pos.y + '">' + street.name + ' (' + street.municipality + ')</a>')
                    $('<a id="result-'+counter+'" x="'+pos.x+'" y="'+pos.y+'" street="'+street.name+'" streetNumber="'+streetNumber+'" class="street button" href="javascript:highlightFilterSelection(\''+counter+'\')">' + street.name + (streetNumber!=""?", "+streetNumber:"") +' (' + street.postCode+' ' +street.municipality + ')</a>')
                            .appendTo($(proposal))
                            .wrap('<li />');
                    counter++;
                }
                //If only 1 result the select it automatically
                if (counter == 1) {
                    highlightFilterSelection('0');
                }
            } else {
                $(searchValue).removeClass('loading');
                if(response.status == "noresult" || response.status == "success") {
                    $(proposal).html('<p class="error-msg">No corresponding address has been found</p>').slideDown();
                } else {
                    $(proposal).html('<p class="error-msg">' + response.status + '</p>').slideDown();
                }
             }
        });
    });
});

function getUrlForPageNumber(number) {
    var url = window.location.href;
    if(url.indexOf("page=")!=-1){

        var list = url.split("page=");
        url1= list[0].replace(/\&amp;/g,'&');
        url1 = url1.replace("amp;","");
        url = url1 + "page="+ number;

    } else if(url.indexOf("?")!=-1) {
        url += "&page="+number;
    } else {
        url += "?page="+number;
    }

    window.location= url;
}


/**
 * Activate the rayon or not
 */
/*function activateRayon() {
    var rayonActivated = $('#rayonCheckbox').attr('checked');

        if (rayonActivated == 'checked') {
        $('#rayon').prop('disabled',null);
    } else {
        $('#rayon').prop('disabled','disabled');
    }
}*/


/**
 * Highlight street selection
 */
function highlightFilterSelection(id) {
    $('#proposal').find('a').removeClass('selected');
    $('#result-'+id).addClass('selected');
    $("#search-by-address").show();
}

/**
 * When filtering reports
 */

</script>
{% endblock %}

{% block content %}
<div class="row">
    <h1 class="span12">
    {% if status == "all" %}
    {% trans 'All reports' %}
    {% endif %}
    {% if status == "created" %}
    {% trans 'Created reports' %}
    {% endif %}
    {% if status == "in_progress" %}
    {% trans 'In progress reports' %}
    {% endif %}
    {% if status == "in_progress_and_assigned" %}
    {% trans 'In progress and assigned reports' %}
    {% endif %}
    {% if status == "closed" %}
    {% trans 'Closed reports' %}
    {% endif %}
    </h1>
    <div id="incident_filter" class="span12">
        <ul>
            <li>
                {% trans 'Filter the incidents by:' %}
            </li>
            <li>
                <a href="{% url report_list_pro 'all' %}" {% ifequal status 'all' %} class="active"{% endifequal %}>
                    <img src="{{STATIC_URL}}images/pin-fixmystreet-L.png" width="40px" height="54px"> <span id="all">{% trans 'All reports' %}</span>
                </a>
            </li>
            <li>
                <a href="{% url report_list_pro 'created'%}" {% ifequal status 'created' %} class="active"{% endifequal %}>
                    <img src="{{STATIC_URL}}images/pin-red-L.png"> <span id="created">{% trans 'Unpublished' %}</span>
                </a>
            </li>
            <li>
                <a href="{% url report_list_pro 'in_progress' %}" {% ifequal status 'in_progress' %} class="active"{% endifequal %}>
                    <img src="{{STATIC_URL}}images/pin-orange-L.png"> <span id="in_progress">{% trans 'In progress' %}</span>
                </a>
            </li>
            <li>
                <a href="{% url report_list_pro 'in_progress_and_assigned' %}" {% ifequal status 'in_progress_and_assigned' %} class="active"{% endifequal %}>
                    <img src="{{STATIC_URL}}images/pin-orange-executed-L.png"> <span id="in_progress_and_assigned">{% trans 'In progress and assigned' %}</span>
                </a>
            </li>
            <li>
                <a href="{% url report_list_pro 'closed' %}" {% ifequal status 'closed' %} class="active"{% endifequal %}>
                    <img src="{{STATIC_URL}}images/pin-green-L.png"> <span id="closed">{% trans 'Closed' %}</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="span8">
        {% if request.fmsuser.leader or request.fmsuser.manager or request.fmsuser.agent %}
        <p class="btn-group pull-right">
            <a href="{% url report_list_pro status %}?ownership=responsible" class="btn{% ifequal ownership 'responsible' %} active{% endifequal %}">{% trans 'My Reports' %}</a>
            <a href="{% url report_list_pro status %}?ownership=entity" class="btn{% ifequal ownership 'entity' %} active{% endifequal %}">{% trans 'All Reports' %}</a>
            <a href="{% url report_list_pro status %}?ownership=subscribed" class="btn{% ifequal ownership 'subscribed' %} active{% endifequal %}">{% trans 'My Subscriptions' %}</a>
        </p>
        {% endif %}
        {% if reports %}
            <div id='search_results' style="clear: both;">
                <a id="create_report_fastlink" href="{% url report_prepare_pro %}" class="report">
                   <h3 class="report-title">{% trans "create_report" %}</h3>
                </a>
                {% for report in reports %}
                {% include "reports/_navigation.html" with url=report.get_absolute_url_pro %}
                {% endfor %}
                {% if pages_list|length > 1 %}
                <div class="pagination pagination-centered">
                    <ul>
                        <li>
                            <a class="pagination_prev"{% if page_number != 1 %} class="active"{% endif %}></a>
                        </li>
                        {% for number in pages_list %}
                        <li>
                            <a{% if page_number == number %} class="active"{% endif %} data-page="{{ number }}">{{ number }}</a>
                        </li>
                        {% endfor %}
                        <li>
                            <a class="pagination_next" {% if page_number != pages_list|last %} class="active"{% endif %}></a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        {% else %}
            <p>{% trans "No problems have been reported in this area." %}</p>
        {% endif %}
    </div>
    <div class="span4">
        <div id="search_by_commune_or_address">
            <form id="search-street">
                <!-- TODO create logic behind searching -->
                <p>1. {% trans "Search by commune or address:" %}</p>
                <div>
                    <input type="search" class="input-block-level" name="q" {% if location %}value="{{location}}"{% endif %} placeholder="{% trans 'Street name, Street number...' %}" id="input-commune-search" style="box-sizing:border-box;"><br /><br />
                    <select id="input-ward" class="input-medium" onchange="javascript:filterReports()">
                        <option value="">{% trans "All communes..." %}</option>
                        {% for zip in zipcodes %}
                            <option value={{zip.code}}>{{zip.code}} {{zip.name}}</option>
                        {% endfor %}
                    </select>

                    <button type="button" class="btn" onclick="javascript:filterReports()" id="filterReports">{% trans 'Search street' %}</button>
                </div>
                <div id="search_by_commune_or_address_section_results" style="display:none">
                    <p>2. {% trans "Results" %}</p>
                    <ul id="proposal" class="inline"> </ul>
                </div>
            </form>
            <form id="search-by-address" style="display:none">
                <p>3. {% trans "Within a distance of" %} ({% trans 'Optional' %})</p>
                <select id="rayon" class="input-large">
                    <option value="">{% trans 'All'%}</option>
                    <option value="50">50m</option>
                    <option value="100">100m</option>
                    <option value="200">200m</option>
                </select>
                <input class="btn" type="submit" id="applyFilter" value="{% trans 'Filtrer list of reports' %}">
            </form>
        </div>
        <form action="{% url search_ticket_pro %}" id="search_by_ticket_nr">
            <!-- TODO create logic behind searching -->
            <p >{% trans "Search by entering a ticket number:" %}</p>
            <div class="input-append input-block-level">
                <input id="input-search" type="search" name="report_id" placeholder="{% trans 'Insert your ticket number here' %}" class="" id="input-commune-search">
                <input type="submit" class="btn" id="filterReports" value="{% trans 'Search' %}"></button>
            </div>
        </form>
        <div id="go_to_submit_report">
            <a class="btn" href="{% url home_pro %}">{% trans 'Report an incident' %}</a>
        </div>
    </div>
</div>
{% endblock %}
