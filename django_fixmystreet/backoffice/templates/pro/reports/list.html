{% extends "reports/list.html" %}
{% load i18n tags %}
{% block title %}{% blocktrans %}{{status}} Reports{%endblocktrans%}{% endblock %}
{% block script %}
{{ block.super }}
<script>
$(document).ready(function() {
    var $form = $('#report_form');

    /**
     * Method used to filter report on list
     */
    $('#search-by-address').submit(function applyFilterReports(evt) {
        evt.preventDefault();
        $("#search_by_commune_or_address_section_results").hide();
        $("#search_by_commune_or_address_section_distance").hide();
        var selectedFilterElements = $('#proposal').find('a.selected');
        if (selectedFilterElements.length > 0) {
            var valueX = $(selectedFilterElements).attr('x');
            var valueY = $(selectedFilterElements).attr('y');
            var valueStreet = $(selectedFilterElements).attr('street');
            var valueStreetNumber = $(selectedFilterElements).attr('streetNumber');
            var valueRayon = $('#rayon').val();
            var rayonChecked = valueRayon != "";
            if (rayonChecked) {
                window.location="{% url 'report_list_pro' 'all' %}?x="+valueX+"&y="+valueY+"&street="+valueStreet+"&streetNumber="+valueStreetNumber+"&rayon="+valueRayon+"&page=1";
            } else {
                window.location="{% url 'report_list_pro' 'all' %}?x="+valueX+"&y="+valueY+"&street="+valueStreet+"&streetNumber="+valueStreetNumber+"&page=1";
            }
        }
    });

    $('#search-street').submit(function filterReports(evt) {
        evt.preventDefault();
        //Hide distance section
        $("#search-by-address").hide();

        //Do not search when field is empty
        searchValue = $('#input-commune-search').val();
        if (searchValue == "") return false;

        var proposal = $('#proposal');
        $(proposal).children().remove();
        $("#search_by_commune_or_address_section_results").show();
        wardValue = $('#input-ward').val();
        if (!searchValue) { return; }
        $.ajax({
           url: URBIS_URL + 'service/urbis/Rest/Localize/getaddressesfields',
           dataType:'jsonp',
           data:{
              json:'{"language": "' + LANGUAGE_CODE + '",' +
                      '"address": {' +
                         '"street": {' +
                             '"name": "' + searchValue.replace("\"","\\\"") + '",' +
                             '"postcode": "' + wardValue.replace("\"","\\\"") + '"' +
                           '},"number": ""' +
                      '}}'
           }
        }).success(function(response) {
            if(response.status == 'success' && response.result.length > 0) {
                $(proposal).empty();
                var counter = 0;
                for(var i in response.result) {
                    var street = response.result[i].address.street;
                    var streetNumber = response.result[i].address.number;
                    var pos = response.result[i].point;
                    //$('<a class="street button" href="' + NEXT_PAGE_URL + '?x=' + pos.x + '&y=' + pos.y + '">' + street.name + ' (' + street.municipality + ')</a>')
                    $('<a id="result-'+counter+'" x="'+pos.x+'" y="'+pos.y+'" street="'+street.name+'" streetNumber="'+streetNumber+'" class="street button" href="javascript:highlightFilterSelection(\''+counter+'\')">' + street.name + (streetNumber!=""?", "+streetNumber:"") +' (' + street.postCode+' ' +street.municipality + ')</a>')
                            .appendTo($(proposal))
                            .wrap('<li />');
                    counter++;
                }
                //If only 1 result the select it automatically
                if (counter == 1) {
                    highlightFilterSelection('0');
                }
            } else {
                $(searchValue).removeClass('loading');
                if(response.status == "noresult" || response.status == "success") {
                    $(proposal).html('<p class="error-msg">No corresponding address has been found</p>').slideDown();
                } else {
                    $(proposal).html('<p class="error-msg">' + response.status + '</p>').slideDown();
                }
             }
        });
    });
});
/**
 * Activate the rayon or not
 */
/*function activateRayon() {
    var rayonActivated = $('#rayonCheckbox').attr('checked');

        if (rayonActivated == 'checked') {
        $('#rayon').prop('disabled',null);
    } else {
        $('#rayon').prop('disabled','disabled');
    }
}*/


/**
 * Highlight street selection
 */
function highlightFilterSelection(id) {
    $('#proposal').find('a').removeClass('selected');
    $('#result-'+id).addClass('selected');
    $("#search-by-address").show();
}

/**
 * When filtering reports
 */

</script>
{% endblock %}

{% block content %}
<div class="">
    <h1 class="span12">
    {% if status == "all" %}
    {% trans 'All reports' %}
    {% endif %}
    {% if status == "created" %}
    {% trans 'Created reports' %}
    {% endif %}
    {% if status == "in_progress" %}
    {% trans 'In progress reports' %}
    {% endif %}
    {% if status == "in_progress_and_assigned" %}
    {% trans 'In progress and assigned reports' %}
    {% endif %}
    {% if status == "closed" %}
    {% trans 'Closed reports' %}
    {% endif %}
    </h1>

    {% with ownership=request.GET.ownership street=request.GET.street streetNumber=request.GET.streetNumber rayon=request.GET.rayon %}

        <div id="legend-container" class="row" style="text-align:right;margin:5px 0 0 0;height:16px;">
            <a  style="float:none;"
                href="#"
                data-toggle="popover"
                data-trigger="hover"
                data-placement="left"
                title="{% trans 'Legend' %}" class="pull-left">
                    <img src="{{STATIC_URL}}images/info_icon.png" width="16px"/>
            </a>
            <div id="legend-recommendations" class="hide" style="width: 600px;">
                <p><img src="{{STATIC_URL}}images/pin-red-XS.png"/> {% trans 'Incident signalé' %}</p>
                <p><img src="{{STATIC_URL}}images/reg-pin-red-XS.png"/> {% trans 'Incident signalé sur une voie régionale' %}</p>
                <p><img src="{{STATIC_URL}}images/pro-pin-red-XS.png"/> {% trans 'Incident signalé par un professionnel' %}</p>
                <hr/>
                <p><img src="{{STATIC_URL}}images/pin-orange-XS.png"/> {% trans 'Incident en traitement' %}</p>
                <p><img src="{{STATIC_URL}}images/reg-pin-orange-XS.png"/> {% trans 'Incident en traitement sur une voie régionale' %}</p>
                <p><img src="{{STATIC_URL}}images/pro-pin-orange-XS.png"/> {% trans 'Incident en traitement signalé par un professionel' %}</p>
                <hr/>
                <p><img src="{{STATIC_URL}}images/pin-orange-executed-XS.png"/> {% trans 'Incident en traitement et assigné' %}</p>
                <p><img src="{{STATIC_URL}}images/reg-pin-orange-executed-XS.png"/> {% trans 'Incident en traitement sur une voie régionale et assigné' %}</p>
                <p><img src="{{STATIC_URL}}images/pro-pin-orange-executed-XS.png"/> {% trans 'Incident en traitement signalé par un professionnel et assigné' %}</p>
                <hr/>
                <p><img src="{{STATIC_URL}}images/pin-green-XS.png"/> {% trans 'Incident clôturé' %}</p>
                <p><img src="{{STATIC_URL}}images/reg-pin-green-XS.png"/> {% trans 'Incident clôturé sur une voie régionale' %}</p>
                <p><img src="{{STATIC_URL}}images/pro-pin-green-XS.png"/> {% trans 'Incident clôturé par un professionnel' %}</p>
            </div>
        </div>

        <div id="incident_filter" class="span12">
            <ul>
                <li>
                    {% trans 'Filter the incidents by:' %}
                </li>
                <li>
                    <a
                        href="{% url 'report_list_pro' 'all' %}?ownership={{ ownership }}&street={{ street }}&streetNumber={{ streetNumber }}&rayon={{ rayon }}"
                        {% ifequal status 'all' %} class="active"{% endifequal %}>

                        <img src="{{STATIC_URL}}images/pin-fixmystreet-L.png" width="40px" height="54px"> <span id="all">{% trans 'All reports' %}</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'report_list_pro' 'created'%}?ownership={{ ownership }}&street={{ street }}&streetNumber={{ streetNumber }}&rayon={{ rayon }}" {% ifequal status 'created' %} class="active"{% endifequal %}>
                        <img src="{{STATIC_URL}}images/pin-red-L.png"> <span id="created">{% trans 'Unpublished' %}</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'report_list_pro' 'in_progress' %}?ownership={{ ownership }}&street={{ street }}&streetNumber={{ streetNumber }}&rayon={{ rayon }}" {% ifequal status 'in_progress' %} class="active"{% endifequal %}>
                        <img src="{{STATIC_URL}}images/pin-orange-L.png"> <span id="in_progress">{% trans 'In progress' %}</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'report_list_pro' 'in_progress_and_assigned' %}?ownership={{ ownership }}&street={{ street }}&streetNumber={{ streetNumber }}&rayon={{ rayon }}" {% ifequal status 'in_progress_and_assigned' %} class="active"{% endifequal %}>
                        <img src="{{STATIC_URL}}images/pin-orange-executed-L.png"> <span id="in_progress_and_assigned">{% trans 'In progress and assigned' %}</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'report_list_pro' 'closed' %}?ownership={{ ownership }}&street={{ street }}&streetNumber={{ streetNumber }}&rayon={{ rayon }}" {% ifequal status 'closed' %} class="active"{% endifequal %}>
                        <img src="{{STATIC_URL}}images/pin-green-L.png"> <span id="closed">{% trans 'Closed' %}</span>
                    </a>
                </li>
            </ul>

        </div>

        <div class="span8">
            {% if request.fmsuser.leader or request.fmsuser.manager or request.fmsuser.agent %}
            <p class="btn-group pull-right">
                <a href="{% url 'report_list_pro' status %}?ownership=responsible&street={{ street }}&streetNumber={{ streetNumber }}&rayon={{ rayon }}" class="btn{% ifequal ownership 'responsible' %} active{% endifequal %}">{% trans 'My Reports' %}</a>
                <a href="{% url 'report_list_pro' status %}?ownership=entity&street={{ street }}&streetNumber={{ streetNumber }}&rayon={{ rayon }}" class="btn{% if ownership == 'entity' or ownership == '' %} active{% endif %}">{% trans 'All Reports' %}</a>
                <a href="{% url 'report_list_pro' status %}?ownership=subscribed&street={{ street }}&streetNumber={{ streetNumber }}&rayon={{ rayon }}" class="btn{% ifequal ownership 'subscribed' %} active{% endifequal %}">{% trans 'My Subscriptions' %}</a>
            </p>
            {% endif %}

            {% if reports %}
                <div id='search_results' style="clear: both;">
                    <a id="create_report_fastlink" href="{% url 'report_prepare_pro' %}" class="report">
                       <h3 class="report-title">{% trans "create_report" %}</h3>
                    </a>
                    {% for report in reports %}
                    {% include "reports/_navigation.html" with url=report.get_absolute_url_pro %}
                    {% endfor %}
                    {% include "_paginator.html" with page=reports %}
                </div>
            {% else %}
                <p>{% trans "No problems have been reported in this area." %}</p>
            {% endif %}
        </div>
    {% endwith %}

    <div class="span4">
        <div id="search_by_commune_or_address" class="block highlighted">
            <form id="search-street">
                <!-- TODO create logic behind searching -->
                <h2>{% trans "Search address:" %}</h2>
                <input type="search" class="input-block-level" name="q" {% if location %}value="{{location}}"{% endif %} placeholder="{% trans 'Street name, Street number...' %}" id="input-commune-search" style="box-sizing:border-box;">
                <div class="form-search">
                    <select id="input-ward" class="input-medium" onchange="javascript:filterReports()">
                        <option value="">{% trans "All communes..." %}</option>
                        {% for zip in zipcodes %}
                            <option value={{zip.code}}>{{zip.code}} {{zip.name}}</option>
                        {% endfor %}
                    </select>

                    <input type="submit" class="btn" id="filterReports" value="{% trans 'Search street' %}"/>
                </div>
                <div id="search_by_commune_or_address_section_results" style="display:none">
                    <ul id="proposal" class="inline"> </ul>
                </div>
            </form>
            <form id="search-by-address" style="display:none">
                <p>{% trans "within a radius of:" %}</p>
                <select id="rayon" class="input-block-level">
                    <option value="">{% trans 'No limit'%}</option>
                    <option value="50">50m</option>
                    <option value="100">100m</option>
                    <option value="200">200m</option>
                </select>
                <input class="btn" type="submit" id="applyFilter" value="{% trans 'Filtrer list of reports' %}">
            </form>
        </div>
        <form action="{% url 'search_ticket_pro' %}" class="block highlighted" id="search_by_ticket_nr">
            <!-- TODO create logic behind searching -->
            <h2>{% trans "Search by ticket number:" %}</h2>
            <div class="form-search">
                <input id="input-search" type="search" name="report_id" placeholder="{% trans 'Ticket number' %}">
                <input type="submit" class="btn" id="filterReports" value="{% trans 'Search' %}"/>
            </div>
        </form>
        <div id="go_to_submit_report">
            <a class="btn" href="{% url 'home_pro' %}">{% trans 'Report an incident' %}</a>
        </div>
    </div>
</div>
{% endblock %}
