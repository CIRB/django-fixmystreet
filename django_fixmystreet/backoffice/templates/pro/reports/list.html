{% extends "pro/base.html" %}
{% load i18n tags %}
{% block title %}{% blocktrans %}{{status}} Reports{%endblocktrans%}{% endblock %}
{% block script %}
{{ block.super }}
<script>

$(document).ready(function() {

	var $form = $('#report_form');
	var $map = $('#map-bxl');

	// $map.fmsMap({
	// 	apiLang:'{{ LANGUAGE_CODE }}',
 //        localizeUrl: 'http://{{ SERVICE_GIS }}/urbis/Rest/Localize/getaddressfromxy',
 //        urbisUrl: 'http://{{ GEOSERVER }}/geoserver/wms',
 //        origin:{
	// 		x:{{ pnt.x }},
	// 		y:{{ pnt.y }}
	// 	}
	// });
	// {% for report in reports %}
	// $map.fmsMap('addReport', {{ report.to_JSON|dict_to_json|safe }},{{forloop.counter}});
	// {% endfor %}
	// $map.fmsMap('addIndicator',{'x':{{ pnt.x }}, 'y':{{ pnt.y }}});

	// $map.bind('reportselected',function(evt, point, report){
	// 	window.location.assign('{{ report.get_absolute_url_pro }}');
	// });

	fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    URBIS_URL + '/geoserver/wms',
        {% if reports.0 %}
        origin:{
            x:{{ reports.0.point.x }},
            y:{{ reports.0.point.y }}
        }
        {% endif %}
    });
    {% for report in reports %}
    fms.currentMap.addReport({{ report.to_JSON|dict_to_json|safe }}, {{forloop.counter}}, true);
    {% endfor %}

	/*Hide the edition form*/
	$('#report_form').hide();
	$('#nearby-reports').show();

    //Highlight the selected filter
    $("#incident_filter").find("span[id$="+window.location.href.substr(window.location.href.lastIndexOf('/') + 1).toString().split("?")[0]+"]").addClass("selected");
    // Add the active class to the active page number
    $("#page_{{request.GET.page}}").addClass("active");
    // Set the state of the arrow buttons (active or inactive)
    if("{{request.GET.page}}"=="1"){
        $(".pagination_prev").removeClass("active");
    }
    else{
        $(".pagination_prev").addClass("active");
    }
    if("{{pages_list|last}}"=="{{request.GET.page}}"){
        $(".pagination_next").removeClass("active");
    }
    else{
        $(".pagination_next").addClass("active");
    }
    //Add onclick event for arrows
    $(".pagination_next.active").bind("click",function(){
        window.location = "{% url report_list_pro status %}?page="+(parseInt("{{request.GET.page}}")+1);
    });
    $(".pagination_prev.active").bind("click",function(){
        window.location = "{% url report_list_pro status %}?page="+(parseInt("{{request.GET.page}}")-1);
    });
});
</script>
{% endblock %}

{% block content %}
<article id="map">
</article>
<div id="page_content_container">
    <h1>{% blocktrans %}{{status}} Reports{%endblocktrans%}</h1>
    <div id="incident_filter">
    	<ul>
    		<li>
    			{% trans 'Filter the incidents by:' %}
    		</li>
    		<li>
    			<a href="{% url report_list_pro 'all' %}?page=1"><img src="{{STATIC_URL}}images/pin-fixmystreet-XL.png" width="40px" height="54px"> <span id="all">{% trans 'All reports' %}</span></a>
    		</li>
    		<li>
    			<a href="{% url report_list_pro 'created'%}?page=1"><img src="{{STATIC_URL}}images/pin-red-L.png"> <span id="created">{% trans 'Unpublished' %}</span></a>
    		</li>
    		<li>
    			<a href="{% url report_list_pro 'in_progress' %}?page=1"><img src="{{STATIC_URL}}images/pin-orang-L.png"> <span id="in_progress">{% trans 'In progress' %}</span></a>
    		</li>
    		<li>
    			<a href="{% url report_list_pro 'closed' %}?page=1"><img src="{{STATIC_URL}}images/pin-green-L.png"> <span id="closed">{% trans 'Closed' %}</span></a>
    		</li>
    	</ul>
    </div>
	<div id="leftcol">
		<div id="nearby-reports">
            {% if reports %}
                <div id='search_results'>
                <!-- <a id="create_report_fastlink" href="/pro/" class="report">
                   <h3 class="report-title">{% trans "create_report" %}</h3>
                </a> -->
                {% for report in reports %}
                {% include "reports/_navigation.html" with url=report.get_absolute_url_pro %}
                {% endfor %}
                </div>
                <div class="pagination pagination-centered">
                	<ul>
                		<li><a class="pagination_prev"></a></li>
                        {% for number in pages_list %}
                		<li id="page_{{number}}" ><a href="{% url report_list_pro status %}?page={{number}}">{{number}}</a></li>
                        {% endfor %}
                		<li><a class="pagination_next"></a></li>
                	</ul>
                </div>
            {% else %}
                <p>{% trans "No problems have been reported in this area." %}</p>
            {% endif %}
		</div>

		<form enctype="multipart/form-data" method="post" action="" id='report_form' style="display:none;">
            <h2>
                {% trans "Fill the report" %}
            </h2>
			<table class='form'>
				<tr>
					<th></th>
					<td id="required_note">{% trans "* This fields are required" %}</td>
				</tr>
				{{ report_form.as_table }}
				<tr>
					<td></td>
					<td><div id='secondary_container'></div></td>
				</tr>
				<tr>
					<td></td>
					<td align="right">
                        <p>
                            <input type="submit" class='big_button' value="{% trans 'Submit' %}" />
                        </p>

                    </td>
				</tr>
			</table>
		</form>
	</div>
	<div id="rightcol">
		<div id="search_by_ticket_nr">
            <!-- TODO create logic behind searching -->
            <p >{% trans "Search by entering a ticket number:" %}</p>
            <input id="input-search" class="input_search_ticket" type="search" name="search_ticket" placeholder="{% trans 'Insert your ticket number here' %}" />
            <p style="float:right">
                <input type="submit" class='btn' value="{% trans 'Search' %}" />
            </p>
		</div>
        <div id="go_to_submit_report">
            <input type="button" class='btn' value="{% trans 'Report an incident' %}" onclick="window.location.href='/pro/'"/>
        </div>
            
	</div>
</div>
{% endblock %}
