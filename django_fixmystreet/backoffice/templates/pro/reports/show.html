{% extends "reports/show.html" %}
{% load i18n %}
{% load tags %}

{% block title %}{{report.secondary_category.name}} {{report.category.name}} {% trans 'in' %} {{report.responsible_entity.name}}{% endblock %}

{% block script %}
{{ block.super }}

{% block specific_scripts %}
<script>
var URL_REPORT_REFUSE = "{% url report_refuse_pro report.id %}";
$(function(){
 /**********************************************/
    /* Prepare iphone toogle button look and feel */
    /**********************************************/
    $(":checkbox.normal").iphoneStyle({ background: "#F9F3E8",onChange:function(value){
        var vals = $(value).attr("id").split("_");
        if(vals[0].indexOf("public")!=-1){
                    // Public checkbox changed
                    if(vals[1].indexOf("file")!=-1){
                    //TODO handle public bool of file with id vals[2]
                    window.location = '{% url report_update_file report.id %}?fileId='+vals[2]+'&updateType=valid&updateValue='+ $(value).attr("checked");
                }
                else{
                    //TODO handle public bool of comment with id vals[2]
                    window.location = '{% url report_update_comment report.id %}?commentId='+vals[2]+'&updateType=valid&updateValue='+ $(value).attr("checked");
                }
            }
            else{
                    //Confidential checkbox changed
                    if(vals[1].indexOf("file")!=-1){
                        //TODO handle Confidential bool of file with id vals[2]
                        window.location = '{% url report_update_file report.id %}?fileId='+vals[2]+'&updateType=confidential&updateValue='+ $(value).attr("checked");
                    }
                    else{
                        //TODO handle Confidential bool of comment with id vals[2]
                        window.location = '{% url report_update_comment report.id %}?commentId='+vals[2]+'&updateType=confidential&updateValue='+ $(value).attr("checked");
                    }
                }
            } });

/***************************/
/* Set the current manager */
/***************************/
$("#report_responsible_manager_select").val("manager_{{report.responsible_manager.id}}");

/*************************************************************/
/* Implement method when changing manager using the dropdown */
/*************************************************************/
$("#report_responsible_manager_select").bind("change",function(event){
    var r=confirm("Are you sure you want to change the responsable manager? This action cannot be undone.");
    if (r==true){
        window.location = '{% url report_change_manager_pro report.id %}?manId='+$("#report_responsible_manager_select").val();
    }
    else{
        $("#report_responsible_manager_select").val("manager_{{report.responsible_manager.id}}");
    }
});
/******************************/
/* Set the current contractor */
/******************************/
$("#report_responsible_impetrant_contractor_select").val("contractor_{{report.subcontractor.id}}");

/****************************************************************/
/* Implement method when changing contractor using the dropdown */
/****************************************************************/
$("#report_responsible_impetrant_contractor_select").bind("change",function(event){
            //TODO update report with new contractor
            window.location = '{% url report_change_contractor_pro report.id %}?contractorId='+$("#report_responsible_impetrant_contractor_select").val();
        });

});
/* When JQUERY is ready*/
$(document).ready(function() {
    /*Set the contractor dropdown*/
    $('#report_responsible_impetrant_contractor_select').val('{{report.contractor.id}}');
});

</script>
<script src="{{ STATIC_URL}}js/reports_show_pro.js"></script>
{% endblock %}
{% endblock %}

{% block css %}
{{ block.super }}
{% endblock %}
{% block content %}
<div id="page_content_container">

{% block pageHeader %}
    	<h1>
	<!-- ########################### -->
	<!-- # DISPLAY REPORT CATEGORY # -->
	<!-- ########################### -->
        {{report.secondary_category.name}} 
        <div style="float:right;margin-top:-23px">
            <table class="reportActionButtons">
		<!-- ################################################### -->
		<!-- # ONLY THE MANAGER AND CONTRACTOR CAN USE BUTTONS # -->
		<!-- ################################################### -->
        	{% if report.responsible_manager.id == request.user.id or report.contractor.id = fms_user.organisation.id %}
			<!-- ############################################# -->
			<!-- # DISPLAY WHEN REPORT STATUS IS IN PROGRESS # -->
			<!-- ############################################# -->
			{% if report.is_in_progress %}
                	<tr>
				<td>
					{% if not fms_user.contractor %} 
                        		<button onclick="window.location = '{% url report_close_pro report.id %}'" class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;">Cloturer</button>
    					{% endif %}
                    		</td>
				<td >
					&nbsp;
                    		</td>
	                    	<td >
				{% if report.is_markable_as_solved %} 
                	        	<button onclick="window.location = '{% url report_fix_pro report.id %}'" class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;">Mark as done</button>
    				{% endif %}
	                    	</td>
        	                <td >
					{% if not fms_user.contractor %} 
                        	    	<button class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;" onclick="window.location = '{% url report_validate_all_pro report.id %}'" >{% trans 'Validate all' %}</button>
    					{% endif %}
	                        </td>	
				<td>
					&nbsp;
				</td>
                	</tr>
    			{% endif %}
                	<tr>
			<!-- ######################################### -->
			<!-- # DISPLAY WHEN REPORT STATUS IS CREATED # -->
			<!-- ######################################### -->
			{% if report.is_created %} 
                    		<td>
                        		<button onclick="window.location = '{% url report_accept_pro report.id %}'" class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;">{% trans 'Publish' %}</button>
	                    	</td>
                    		<td>
                        		<button onclick="refuse();" class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;">{% trans 'Reject' %}</button>
	                    	</td>
                        	<td>
	                            <button onclick="window.location = '{% url report_accept_and_validate report.id %}'" class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;">{% trans 'Publish All' %}</button>
        	                </td>
    			{% endif %}
		        <td>
                            <button onclick="window.location = '{% url report_pdf_pro report.id 1 %}'" class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;">{% trans 'report pdf' %}</button>
			</td>	
		        <td>
                            <button onclick="window.location = '{% url report_pdf_pro report.id 0 %}'" class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;">{% trans 'report pdf public' %}</button>
			</td>	
               	{% endif %}
                </tr>
            </table>
        </div>
    </h1>
{% endblock %}
	<!-- ##################################### -->
	<!-- # SMALL SECTION TO SUBSCRIBE OR NOT # -->
	<!-- ##################################### -->
    	<div style="border-bottom:1px solid black; padding-bottom:30px">
		<div id="leftcol">    
			{% if report.markedAsFinished %}
				<div class='is_fixed'>{% trans "This problem has been fixed." %}</div>
			{% endif %}
		<div id='report-body'>
            		<div id='report-subscribers'>
                		{% trans "Subscribers:" %} <b>{{report.reportsubscription_set.count}}</b><br/>					
		                {% if not report.is_closed and user.is_authenticated %}
                		    {% if not subscribed %}
			                    <a href="{% url subscribe_pro report.id %}">{% trans "Subscribe" %}</a>
		                    {% else %}
                			    <p><small>{% trans "You've subscribed for updates" %}</small></p>
			                    <a href="{% url unsubscribe_pro report.id %}">{% trans "Unsubscribe" %}</a>
		                    {% endif %}
		                {% endif %}
            		</div>

			<p>{{report.description|linebreaks}}</p>

			{% if report.photo  %}
				<center><img style="max-width:390px;max-heigth:390px" src='{{ report.photo.url }}'/></center>
			{% endif %}
			<p class="author-sign">
                	{% if report.created_by %}
                		{% blocktrans with by=report.created_by.username on=report.created|date %}
		                Posted by <strong>{{by}}</strong> on <strong>{{on}}</strong>
                		{% endblocktrans %}
	                {% else %}
        		        {% blocktrans with by=report.citizen.first_name on=report.created|date %}
		                Posted by <strong>{{by}}</strong> on <strong>{{on}}</strong>
                		{% endblocktrans %}
	                {% endif %}
            	</p>


		<!-- ################## -->
		<!-- # REPORT DETAILS # -->
		<!-- ################## -->
            	<table id='report-status'>			
	                <tr>
        	            <th>{% trans "Location:" %}</th>
                	    <td>{{report.address}} ({{report.postalcode}} {{report.ward.name}})</td>
	                </tr>
        	        <tr>
                		<th></th>
                		<td><input type="button" class='big_button' onclick="showMap();" value='{% trans "Show on map" %}' ></input></td>
	                </tr>
        	        <tr>
                	    <th>{% trans "Category:" %}</th>
	                    <td>{{report.category.name}} / {{report.secondary_category.name}}</td>
        	        </tr>
                	<tr>
                		<th>{% trans "Status:" %}</th>
	                	<td>{{ report.get_status_display }}</td>
        	        </tr>
                	{% if report.is_in_progress  %}
		                {% if request.user.id == report.responsible_manager.id %}
					<!-- ############################### -->
					<!-- # RESPONSIBLE/ENTITY DROPDOWN # -->
					<!-- ############################### -->
                			<tr>
			                	<th>{% trans "Responsible manager:" %}</th>
                    				<td>
				                        <select id="report_responsible_manager_select">
				                            	<optgroup label="Gestionnaires">
								{% for manager in managers %}
					                            	<option value="manager_{{manager.id}}">{{manager.first_name}} {{ manager.last_name}}</option>
                            					{% endfor %}
			    					</optgroup>
                            					<optgroup label="Entites">
				                            	{% for entity in entities %}
					                            	<option value="entity_{{entity.id}}">{{entity.name}}</option>
				                            	{% endfor %}
			    					</optgroup>
                        				</select>
			                	</td>
                			</tr>
					<!-- ################################# -->
					<!-- # CONTRACTOR/IMPETRANT DROPDOWN # -->
					<!-- ################################# -->
		                	<tr>
                		    		<th>{% trans "Contractor/Impetrant:" %}</th>
                    				<td>
		                        		<select id="report_responsible_impetrant_contractor_select">
                		            			<option value="-1">{% trans 'Select a contractor/impetrant' %}</option>
                            						<optgroup label="Executeur de travaux">
                            							{% for organisation in contractors %}
                            								<option value="{{organisation.id}}">{{organisation.name}}</option>
		                            					{% endfor %}
					    				</optgroup>
                            						<optgroup label="Impetrants">
                            							{% for applicant in applicants %}
                            								<option value="{{applicant.id}}">{{applicant.name_fr}}</option>
		                            					{% endfor %}
					    				</optgroup>
                        				</select>
		                    		</td>
                			</tr>
                		{% else %}
					<!-- ########################################################### -->
					<!-- # RESPONSIBLE / ENTITY / EXECUTANT/ IMPETRANT (READ ONLY) # -->
					<!-- ########################################################### -->
                			<tr>
                    				<th>{% trans "Responsible manager:" %}</th>
				                <td>{{report.responsible_manager.first_name}} {{report.responsible_manager.last_name}}</td>
			                </tr>				
                			<tr>
				                <th>{% trans "Contractor/Impetrant:" %}</th>
				                <td>{{report.contractor.name}}</td>
			                </tr>
                		{% endif %}
                	{% endif %}
            	</table>
		<!-- ################## -->
		<!-- # THE MAP WIDGET # -->
		<!-- ################## -->
		<div id="map-bxl"></div>
		</div>
	</div>

	<!-- ############################ -->
	<!-- # A SECTION TO ADD ANNEXES # -->
	<!-- ############################ -->
	<div id="rightcol">
		{% if report.is_in_progress %} 
		<!-- ############################################# -->
		<!-- # ONLY AVAILABLE WHEN REPORT IS IN PROGRESS # -->
		<!-- ############################################# -->
		<div id="addCommmentDiv">
			<h2>{% trans "Add a comment to this report" %}</h2>
            		<input id="showCommentFormButton" type="button" class="big_button" onclick="toggleCommentForm();" value="Add"/>
			
			<form id="commentForm" enctype="multipart/form-data" action="{% url report_update_pro report.id %}" method="post">
			<table id="report_form" class="form">
				{{comment_form.as_table}}					
				<tr>
                        	<td></td>
                        	<td>
                            		<p style="float:left;">
                            		<input type="hidden" name="form-type" value="comment-form"/>
                                	<input type="submit" class='big_button' value="{% trans 'Add' %}" onclick="setTimeout('toggleCommentForm()',200);"/>
                                	<input type="button" class='big_button' value="{% trans 'Cancel' %}" onclick="toggleCommentForm();"/>
                            		</p>
                        	</td>
                   	 	</tr>
			</table>
			</form>
        	</div>
		<!-- ############################################# -->
		<!-- # ONLY AVAILABLE WHEN REPORT IS IN PROGRESS # -->
		<!-- ############################################# -->
		<div id="addFileDiv">
		<h2>{% trans "Add a file to this report" %}</h2>
            		<input id="showFileFormButton" type="button" class="big_button" onclick="toggleFileForm();" value="Add"/>
			<form id="fileForm" enctype="multipart/form-data" action="{% url report_update_pro report.id %}" method="post">
			<table id="report_form" class="form">
				{{file_form.as_table}}					
				<tr>
                        	<td></td>
                        	<td>
                            		<p style="float:left;">
                            		<input type="hidden" name="form-type" value="file-form"/>
                                	<input type="submit" class='big_button' value="{% trans 'Add' %}" onclick="setTimeout('toggleFileForm()',200);"/>
                                	<input type="button" class='big_button' value="{% trans 'Cancel' %}" onclick="toggleFileForm();"/>
                            	</p>
                        	</td>
                    		</tr>
			</table>
			</form>
		</div>
		{% endif %}
     		
    </div>

    	
    </div>
    <div style="padding-top:30px">
	<!-- ########################## -->
	<!-- # DISPLAY EXISTING FILES # -->
	<!-- ########################## -->
        {% if files %}
            <h3>{% trans "Extra files" %}</h3>
            <div id="report_updates">
                <table id="extraFilesTable">
                    <th></th>
                    <!-- If the status allow such interactions -->      
		    {% if report.is_in_progress %} 
                    <!--If the current user is the responsible manager--> 
                    {% if report.responsible_manager.id == request.user.id %}
                    <th>{% trans 'Public?' %}</th>
                    {% endif %}
                    <!--If the current user is the responsible manager or the creator of the report-->
                    {% if report.responsible_manager.id == request.user.id or report.created_by.id == request.user.id %}
                    <th> {% trans 'Confidentiel?' %} </th>
                    {% endif %}
                    {% endif %}
                    {% for file in files %}
			{% if not file.is_visible and not fms_user.can_see_confidential %}
				<!-- Skip -->
			{% else %}
                    	<tr>
                        	<td class="annexesFirstTD">
                    		<div class="report_update">
                        		{% if file.file %}
                        			<center>
						<!--img style="max-width:390px;max-heigth:390px" src='{{ file.file.url }}'/-->
						{{file.title}}
						{% if file.is_image %}
							<a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-jpeg.png' width="48px" height="48px"/></a>
						{% endif %}
						{% if file.is_pdf %}
							<a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-pdf.png' width="48px" height="48px"/></a>
						{% endif %}
						{% if file.is_word %}
							<a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-doc.png' width="48px" height="48px"/></a>
						{% endif %}
						{% if file.is_excel %}
							<a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-png.png' width="48px" height="48px"/> </a>
						{% endif %}
						</center>
                        		{% endif %}
                    		</div>
                		</td>
        
		<!-- If the status allow such interactions -->		
		{% if report.is_in_progress %}
        <!--If the current user is the responsible manager-->
        {% if report.responsible_manager.id == request.user.id %} 
                	<td class="annexesChoiceBoxTD">
                            {%if file.is_validated%}
                    		<center><input checked='checked' class='normal' type='checkbox' id="public_file_{{file.id}}"/></center>
                            {%else%}
                            <center><input class='normal' type='checkbox' id="public_file_{{file.id}}"/></center>
                            {%endif%}
                	</td>
                    {% endif %}
                    <!--If the current user is the responsible manager or the creator of the report-->
                    {% if report.responsible_manager.id == request.user.id or report.created_by.id == request.user.id %}
                	<td class="annexesChoiceBoxTD">
                            {%if file.is_visible%}
                    		<center><input class='normal' type='checkbox' id="confidential_file_{{file.id}}"/></center>
                            {%else%}
                            <center><input checked='checked' class='normal' type='checkbox' id="confidential_file_{{file.id}}"/></center>
                            {%endif%}
                	</td>
       		{% endif %}
		{% endif %}
            </tr>
		{% endif %}
                    {% endfor %}
            </table>
            </div>
            {% endif %}
	
	<!-- ############################# -->
	<!-- # DISPLAY EXISTING COMMENTS # -->
	<!-- ############################# -->
        {% if comments %}
            	<h3>{% trans "Extra comments" %}</h3>
            	<div id="report_updates">
                <table class="extraCommentsTable">
                    <th></th>
		    <!-- If the status allow such interactions -->      
                    {% if report.is_in_progress %}
                    <!--If the current user is the responsible manager--> 
                    {% if report.responsible_manager.id == request.user.id %}
                    	<th>{% trans 'Public?' %}</th>
                    {% endif %}
                    <!--If the current user is the responsible manager or the creator of the report-->
                    {% if report.responsible_manager.id == request.user.id or report.created_by.id == request.user.id %}
                    	<th> {% trans 'Confidentiel?' %} </th>
                    {% endif %}
                    {% endif %}
                    {% for comment in comments %}
			{% if not comment.is_visible and not fms_user.can_see_confidential %}
				<!-- Skip -->
			{% else %}
                	<tr>
                    		<td class="annexesFirstTD">
                			<div class="report_update">
                    				<h4>{{comment.title}}</h4>
                    				<p>{{comment.text}}</p>
                			</div>
            			</td>
            			<!-- If the status allow such interactions -->      
		            	{% if report.is_in_progress  %}
            			<!--If the current user is the responsible manager-->
            			{% if report.responsible_manager.id == request.user.id %}
                			<td class="annexesChoiceBoxTD">
                    				{% if comment.is_validated %}
                    					<input checked='checked' class='normal' type='checkbox' id="public_comment_{{comment.id}}"/>
                    				{% else %}
                    					<input class='normal' type='checkbox' id="public_comment_{{comment.id}}"/>
                    				{% endif%}
                			</td>
            			{% endif %}
            			<!--If the current user is the responsible manager or the creator of the report-->
            			{% if report.responsible_manager.id == request.user.id or report.created_by.id == request.user.id %}
                			<td class="annexesChoiceBoxTD">
                    				{% if comment.is_visible %}
                    					<input class='normal' type='checkbox' id="confidential_comment_{{comment.id}}"/>
                   				{% else %}
                    					<input class='normal' checked='checked' type='checkbox' id="confidential_comment_{{comment.id}}"/>
                    				{% endif%}
                			</td>
            			{% endif %}
            		{% endif %}
            		</tr>
			{% endif %}
                {% endfor %}
            </table>
            </div>
            {% endif %}
        </div>

        </div>
    
    </div>
    <div id="more-actions">
        <p><a href='{% url flag_report_pro report.id %}'>{% trans "Offensive? Unsuitable? Tell us" %}</a></p>
    </div>


    <div id="dialog" title="Please enter more information about rejecting the report">
        <textarea id="more_information_text" style="display:block;width:100%"></textarea>
        <a href="#" onclick="refuseConfirmButton();" class="saveFormButton" style="float:right;">{% trans 'Confirm'%}</a>
        <a href="#" onclick="refuseCancelButton();" class="saveFormButton" style="float:left;">{% trans 'Cancel'%}</a>
    </div>
</div>
	
{% endblock %}
