{% extends "base.html" %}

{% load i18n tags %}

{% block base %}
<base href="{% if request.is_secure %}https{% else %}http{% endif %}://{{request.get_host}}" target="_blank"/>
{% endblock %}

<!-- ############################################################## -->
<!-- #######################JAVASCRIPT IMPORTS #################### -->
<!-- ############################################################## -->
<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}OpenLayers-2.11/OpenLayers.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/proj4js/engine/proj4js-compressed.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/proj4js/defs/EPSG31370.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/geolocation.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/fixmystreetmap.js"></script>

<!-- ############################################################## -->
<!-- #######################JQUERY INIT METHOD #################### -->
<!-- ############################################################## -->
{% block script %}
{{ block.super }}
    <script>
        $(document).ready(function() {
            fms.currentMap = new fms.Map(
                'map',
                {apiLang:'nl',
                    localizeUrl: 'http://service.gis.irisnet.be/urbis/Rest/Localize/getaddressfromxy',
                    urbisUrl: 'http://geoserver.gis.irisnet.be/geoserver/wms',
                    origin: {
                    x:{{report.point.x}},
                    y:{{report.point.y}}
                    }
                });
            fms.currentMap.addReport({{ report.to_JSON|dict_to_json|safe }}, 1);
            var res = UtilGeolocation.convertCoordinatesToWGS84({{report.point.x}},{{report.point.y}});
            document.getElementById("wgs84").innerHTML="L: " + res.x + " l: "+res.y;
        });
    </script>
{% endblock %}


{% block nav %}
    {% if BACKOFFICE %}
        <img id="banner-pro" src="{{ STATIC_URL }}images/fixmystreet-pro.png" alt="{% trans 'Fix My Street Pro' %}">
    {% endif %}
{% endblock %}
{% block lng %}{% endblock %}

{% block css %}
    {{ block.super }}
    <style>
        header {
            height: 100px;
            width: auto;
            background-color: white;
        }
        body{
            width: 100%;
        }
        h2
        {
            font-size: 26px;
        }
        hr
        {
            border-color: #999;
        }
        div > p
        {
            margin-left:30px;
        }
        .p_title
        {
            margin-left: 0;
        }
        .by
        {
            font-size: x-small;
            text-align: right;
        }

        .container {
            width:700px;
        }
        .olControlZoom {
            display: none;
        }

        .block-left, .block-right {
            width: 300px;
            height: 160px;
            border: 1px solid #999;
            padding:20px;
        }
        .block-left {
            float:left;
        }
        .block-right {
            float:right;
        }
        .block-full {
            width: 660px;
            border: 1px solid #999;
            padding:20px;
        }

        #banner-pro {
            position: absolute;
            bottom: 0;
            right: 30px;
            z-index: 1000000;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="map"></div>
    <!--
        Title
    -->
    <h1 style="position:relative;">
        {% if report.is_in_progress %}
            <img src="{{STATIC_URL}}{{report.get_marker}}" style="width:40px;" />
        {% else %}
            <img src="{{STATIC_URL}}{{report.get_marker}}" style="width:40px;" />
        {% endif %}
        {% trans "Report Ticket" %} {{ report.get_ticket_number }}
    </h1>

    <!--
        Status
    -->

    <div>
        {% if report.is_created %}
            <div class='is_created'>{% trans "This incident is not validated." %}</div>
        {% endif %}

        {% if report.is_in_progress %}
            <div class="is_in_progress">{% trans "This incident is in progress." %}</div>
        {% endif %}

        {% if report.is_closed %}
            <div class='is_fixed'>{% trans "This incident has been closed." %}</div>
        {% endif %}

        {% if report.markedAsFinished %}
            <div class='is_fixed'>{% trans "This problem has been fixed." %}</div>
        {% endif %}
    </div>

    <!--
        Localisation
    -->

    <div class="block-left">
        <p class="p_title"><strong>{% trans 'Location:' %}</strong></p>
        <p>{{report.address}}, {{report.address_number}} ({{report.postalcode}} {{report.get_address_commune_name}})</p>

        <p class="p_title"><strong>{% trans 'Category' %}</strong></p>
        <p>{{report.display_category}}</p>
    </div>

    <div class="block-right">
        <p class="p_title"><strong>{% trans 'Geolocation' %} ({% trans 'Lambert 72 Belgium'%})</strong></p>
        <p>L:{{report.point.x}} l:{{report.point.y}}</p>

        <p class="p_title"><strong>{% trans 'Geolocation' %} (WGS84)</strong></p>
        <p id="wgs84"></p>
    </div>

    <div style="clear:both;"></div>

    <!--
        Reporter
    -->

    <br/>
    <div class="block-left">
        <h2>{% trans 'Created'%}</h2>

        <p>
            <strong>
                {% trans 'By' %}
            </strong>

            {% if report.citizen %}
                {% if pro_version == "1" %}
                    {{report.citizen.fmsuser.get_display_name}},
                    <br/>
                    {{report.citizen.fmsuser.email}}
                    -
                    {{report.citizen.fmsuser.telephone}}
                {% else %}
                    {% trans 'Citizen' %}
                {% endif %}
            {% else %}
                {{report.created_by.fmsuser.get_display_name}},
            {% endif %}
        </p>

        <p>
            <strong>
                {% trans 'on' context 'time' %}
            </strong>
            {{report.created|date}}
        </p>
    </div>


    <!--
        Responsible
    -->

    <div class="block-right">
        <h2>{% trans 'Treated'%}</h2>

        <p>
            <strong>{% trans 'By' %}</strong>

            {% if pro_version == "1" %}
                {{report.responsible_manager.first_name}} {{report.responsible_manager.last_name}} - {{report.responsible_manager.organisation.name}},
                <br/>
                {{report.responsible_manager.email}}
                -
                {{report.responsible_manager.telephone}}
            {% else %}
                {{report.responsible_manager.organisation.name}}
            {% endif %}
        </p>
    </div>

    <div style="clear:both;"></div>

    <!--
        History
    -->

    <br/>
    <div class="block-full" style="padding-top:10px;">
        <h2>{% trans 'History' %}</h2>
        {% if activity_list %}
            {% for activity in activity_list %}
                <p><strong>{{activity.event_at|date}}</strong> : {{ activity.get_status }} <strong>{% trans 'By' %}</strong> {{activity.organisation.name}}</p>
            {% endfor %}
        {% else %}
            <p>{% trans 'No Report History' %}</p>
        {% endif %}
    </div>

    <!--
        Comments
    -->

    {% if comment_list %}
        <br/>
        <div class="block-full" style="padding-bottom:10px;">
            <h2>{% trans 'Comments' %}</h2>
                {% for comment in comment_list %}
                    <p>{{comment.text}}</p>
                    <p class="by">
                        <strong>{% trans 'By' %}</strong>

                        {% if pro_version == "1" %}
                                {% if comment.created_by %}
                                    {{comment.created_by.fmsuser.get_display_name}} {{comment.created_by.fmsuser.organisation.name}},

                                    {{comment.created_by.fmsuser.email}}
                                    -
                                    {{comment.created_by.fmsuser.telephone}}
                                {% else %}
                                    {% trans 'Anonymous '%}
                                {% endif %}
                        {% else %}
                            {% if report.citizen %}
                                {% trans 'Citizen' %}
                            {% else %}
                                {{report.created_by.fmsuser.get_display_name}},
                            {% endif %}
                        {% endif %}

                        <strong>le</strong> {{comment.created|date}}
                    </p>
                    <hr/>
                {% endfor %}
        </div>
    {% endif %}

    <!--
        Photos
    -->

    {% if file_list %}
        {% for file in file_list %}
            <br/>
            <div class="block-full">

                <div style="margin-bottom:20px;">
                    {% if file.file_type == 1 %}
                        <img width="128px" height="128px" src="{{STATIC_URL}}images/icon-pdf.png"/>
                    {% endif %}
                    {% if file.file_type == 2 %}
                        <img width="128px" height="128px" src="{{STATIC_URL}}images/icon-word.jpg"/>
                    {% endif %}
                    {% if file.file_type == 3 %}
                        <img width="128px" height="128px" src="{{STATIC_URL}}images/icon-excel.png"/>
                    {% endif %}
                    {% if file.file_type == 4 %}
                        <img src="{% if request.is_secure %}https{% else %}http{% endif %}://{{request.get_host}}{{file.file.url}}"/>
                    {% endif %}
                </div>

                <hr/>

                <p>
                    <strong>{% trans 'Description' %} : </strong>
                    {{file.title}}
                </p>

                <p>
                    <strong>{% trans 'file creation Date' %}</strong>
                    {% if file.file_creation_date %}
                            {{file.file_creation_date}}
                    {% else %}
                            -
                    {% endif %}
                </p>

                <p>
                    <strong>{% trans 'file publication date' %}</strong>
                    {{file.created|date}}
                </p>

                <p class="by">
                    <strong>{% trans 'By' %}</strong>

                    {% if pro_version == "1" %}
                            {% if file.created_by %}
                                {{file.created_by.fmsuser.get_display_name}} {{file.created_by.fmsuser.organisation.name}},

                                {{file.created_by.fmsuser.email}}
                                -
                                {{file.created_by.fmsuser.telephone}}
                            {% else %}
                                {% trans 'Anonymous '%}
                            {% endif %}
                    {% else %}
                        {% if report.citizen %}
                            {% trans 'Citizen' %}
                        {% else %}
                            {{report.created_by.fmsuser.get_display_name}},
                        {% endif %}
                    {% endif %}
                </p>
            </div>
        {% endfor %}
    {% endif %}

{% endblock %}
