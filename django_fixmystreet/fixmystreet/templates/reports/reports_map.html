{% extends "base.html" %}
{% load i18n %}
{% load tags %}
{% block title %}{% trans "Reports for" %} {{entity.name}}{% endblock %}
{% block css %}
{{ block.super }}

{% endblock %}

{% block meta %}
{{ block.super }}
<meta property="og:title" content="{% trans 'Reports for' %} {{entity.name}}" />
<meta property="og:description" content="{% trans 'Meta description for list page' %}" />
{% endblock %}

{% block script %}
{{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL}}js/search.js"></script>

{% block script_map %}
{{ block.super }}
<script>
var zipcodes = new Object();

{% for zip in zipcodes %}
    zipcodes[{{zip.code}}] = new Object();
    zipcodes[{{zip.code}}].participation = {{ zip.commune.active|yesno:"true,false" }};
    zipcodes[{{zip.code}}].phone = " {{zip.commune.phone}} ";
    zipcodes[{{zip.code}}].commune = "{{zip.commune.name}}";
{% endfor %}

var NEXT_PAGE_URL = null;

$(function(){
    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    WMS_SERVICE_URL
    });
    var markers = [];

    // Layer switcher
    fms.currentMap.map.addControl(new OpenLayers.Control.LayerSwitcher({'div':OpenLayers.Util.getElement('layerswitcher')}));

    window.onload = function() {

        var statusToggleCreated    = document.getElementById('statusToggleCreated');
        var statusToggleInProgress = document.getElementById('statusToggleInProgress');
        var statusToggleClosed     = document.getElementById('statusToggleClosed');

        function applyFilter() {
            // Remove all popups
            while(fms.currentMap.map.popups.length) {
                 fms.currentMap.map.removePopup(fms.currentMap.map.popups[0]);
            }

            var value = this.getAttribute('value');

            if(this.checked){
                fms.statusFilter.push(value);
            }
            else {
                var i = fms.statusFilter.indexOf(value);
                if(i != -1) {
                    fms.statusFilter.splice(i, 1);
                }
            }

            // Apply filter
            fms.filterMapWithStatus();
        }
        statusToggleCreated.addEventListener('change', applyFilter);
        statusToggleInProgress.addEventListener('change', applyFilter);
        statusToggleClosed.addEventListener('change', applyFilter);

        // Init map with all reports
        fms.statusFilter = ['created', 'in_progress', 'closed'];
        fms.filterMapWithStatus();
    }
});

// Override some function from search.js
function getAddressFromPoint() {}

function cleanMap() {
    // Remove all popups
    while(fms.currentMap.map.popups.length) {
         fms.currentMap.map.removePopup(fms.currentMap.map.popups[0]);
    }

    // Remove all features
    if (fms.currentMap.homepageMarkersLayer) {
        fms.currentMap.homepageMarkersLayer.destroyFeatures();
    }

    // Hide results
    $proposalContainer = $('#proposal-container');
    $proposalContainer.slideUp();
}

function initDragMarker(x, y, additionalInfo) {
        cleanMap();

        // Remove message info
        var $map = $('#map');
        map.classList.remove("map-big-message");
        map.classList.add("map-big");

        var $proposalMessage = $('#proposal-message');
        $proposalMessage.slideUp();

        draggableMarker = fms.currentMap.addDraggableMarker(x, y);
        fms.currentMap.centerOnDraggableMarker();
        fms.currentMap.map.zoomTo(6);

        var popupContent = "<p class='popupHeading'>Vous êtes ici</p>";

        if (additionalInfo) {
            popupContent += "<p class='popupContent'>" + additionalInfo.streetName + ", " + additionalInfo.number;
            popupContent += "<br/>" + additionalInfo.postCode + " " + additionalInfo.municipality + "</p>";
        }

        var popup = new OpenLayers.Popup(
            "popup",
            new OpenLayers.LonLat(x, y),
            new OpenLayers.Size(200,150),
            popupContent,
            true
        );
        popup.panMapIfOutOfView = true;

        fms.currentMap.map.addPopup(popup);
}

</script>
{% endblock %}

{% endblock %}

{% block map %}
    <div class="container">
        <div class="row">
            <div class="span12">
                <article id="map" class="map-big">

                    <div id="searchContainer">
                        <div id="newReport">
                            <div class="row">
                                <div class="span12">
                                    <div id="search-form" class="block highlighted">
                                        <form id="search-address-form" class="form-inline search-form">
                                            <div id="address-search-div">
                                                <!--h2>{% trans "Enter the address where the incident is:" %}</h2-->
                                                <input id="input-search" class="input-xxlarge" type="search" name="q" {% if location %}value="{{location}}"{% endif %} placeholder="{% trans 'Street name, Street number...' %}" />
                                                <input id="input-streetnumber"  placeholder="n°" class="input-mini" type="search" />
                                                <select id="input-ward" class="input-large" name="ward">
                                                    <option value="">{% trans "All communes..." %}</option>
                                                    {% for zip in zipcodes %}
                                                        <option value={{zip.code}}>{{zip.code}} {{zip.name}}</option>
                                                    {% endfor %}
                                                </select>
                                                <input id="widget-search-button" class="btn" type="submit" name="submit" value="{% trans 'Rechercher' %}" disabled>
                                            </div>
                                        </form>

                                        <form id="search-ticket-form" class="form-inline" action="{% url 'search_ticket' %}">
                                            <input id="input-ticket-search" class="input-large" type="search" name="q" {% if location %}value="{{location}}"{% endif %} placeholder="{% trans 'Ticket number...' %}" />
                                            <input id="widget-search-ticket-button" class="btn" type="submit" name="submit" value="{% trans 'Access Ticket' %}">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Results -->
                        <div>
                            <p id="proposal-message" class="hide"> </p>
                            <div id="proposal-container" class="inline" hidden>
                                <h3 class="numberResultsContainer"><span id="numberResults"></span> result(s)</h3>
                                <ul id="proposal" ></ul>
                                <p><button id="previousResults" hidden><</button> <button id="nextResults" hidden>></button></p>
                            </div>
                        </div>

                    </div>

                    <div id="layerswitcher" class="olControlLayerSwitcher" style="z-index:999;">
                        <div class="layersDiv">
                            <div class="dataLayersDiv">
                                <h3>{% trans 'Statut' %}</h3>
                                <input type="checkbox" id="statusToggleCreated" value="created" checked="">
                                <label><img src="{{ STATIC_URL }}images/marker-red-xxs.png" />{% trans 'Created' %}</label>
                                <br>
                                <input type="checkbox" id="statusToggleInProgress" value="in_progress" checked="">
                                <label><img src="{{ STATIC_URL }}images/marker-orange-xxs.png" />{% trans 'In progress' %}</label>
                                <br>
                                <input type="checkbox" id="statusToggleClosed" value="closed" checked="">
                                <label><img src="{{ STATIC_URL }}images/marker-green-xxs.png" />{% trans 'Closed' %}</label>
                            </div>
                        </div>

                    </div>

                    <div id="copyright-urbis">Realized by means of Brussels UrbIS®©</div>

                </article>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
{% endblock %}
