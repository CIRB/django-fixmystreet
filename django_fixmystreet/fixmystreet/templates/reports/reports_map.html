{% extends "base.html" %}
{% load i18n %}
{% load tags %}
{% block title %}{% trans "Reports for" %} {{entity.name}}{% endblock %}
{% block css %}
{{ block.super }}

{% endblock %}

{% block meta %}
{{ block.super }}
<meta property="og:title" content="{% trans 'Reports for' %} {{entity.name}}" />
<meta property="og:description" content="{% trans 'Meta description for list page' %}" />
{% endblock %}

{% block script %}
{{ block.super }}

{% block script_map %}
{{ block.super }}
<script>
$(function(){
    var defaultX = 148838.00741428943;
    var defaultY = 171086.0720425099;

    {% if reports.0 %}
        defaultX = {{reports.0.point.x}}
        defaultY = {{reports.0.point.y}}
    {% endif %}


    // $('#map-bxl').fmsMap();
 //    $('#map-bxl').fmsMap('highlightArea', '{{ entity.feature_id }}');

    // {% for report in reports %}
    // $('#map-bxl').fmsMap('addReport',  {{ report.to_JSON|dict_to_json|safe }}, {{ forloop.counter }});
    // {% endfor %}

    // $('#map-bxl').bind('reportselected',function(evt, point, report){
    //     window.location.assign('{{report.get_absolute_url}}');
    // });

    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    WMS_SERVICE_URL,
        origin:{
            x: defaultX,
            y: defaultY
        }
    });
    var reportJSON;
    var markers = [];

    {% for report in all_reports %}
        reportJSON = {{ report.marker_detail_short|dict_to_json|safe }};
        markers.push(fms.currentMap.addReport(reportJSON, {{forloop.counter}}, {% if BACKOFFICE %}true{%else%}false{%endif%}));
    {% endfor %}
    fms.currentMap.markersLayer.addFeatures(markers);

    // Layer switcher
    fms.currentMap.map.addControl(new OpenLayers.Control.LayerSwitcher({'div':OpenLayers.Util.getElement('layerswitcher')}));

    window.onload = function() {

        var statusToggleCreated    = document.getElementById('statusToggleCreated');
        var statusToggleInProgress = document.getElementById('statusToggleInProgress');
        var statusToggleClosed     = document.getElementById('statusToggleClosed');

        function applyFilter() {

            var value = this.getAttribute('value');

            if(this.checked){
                fms.statusFilter.push(value);
            }
            else {
                var i = fms.statusFilter.indexOf(value);
                if(i != -1) {
                    fms.statusFilter.splice(i, 1);
                }
            }

            // Apply filter
            fms.filterMapWithStatus();
        }
        statusToggleCreated.addEventListener('change', applyFilter);
        statusToggleInProgress.addEventListener('change', applyFilter);
        statusToggleClosed.addEventListener('change', applyFilter);
    }
});
</script>
{% endblock %}

{% endblock %}

{% block map %}
<article id="map" class="map-big">
    <div id="layerswitcher" class="olControlLayerSwitcher" style="z-index:999;">
        <div class="layersDiv">
            <div class="dataLayersDiv">
                <input type="checkbox" id="statusToggleCreated" value="created">
                <label>{% trans 'Created' %}</label>
                <br>
                <input type="checkbox" id="statusToggleInProgress" value="in_progress">
                <label>{% trans 'In progress' %}</label>
                <br>
                <input type="checkbox" id="statusToggleClosed" value="closed">
                <label>{% trans 'Closed' %}</label>
            </div>
        </div>

    </div>

    <div id="copyright-urbis">Realized by means of Brussels UrbIS®©</div>
</article>
{% endblock %}

{% block content %}
<div class="">
<!--
    <div class='span4'>
        <form action="{% url 'search_ticket' %}" class="block highlighted" id="search_by_ticket_nr">
            <h2>{% trans "Search by ticket number:" %}</h2>
            <div class="form-search">
                <input id="input-search" type="search" name="report_id" placeholder="{% trans 'Ticket number' %}">
                <input type="submit" class="btn" id="filterReports" value="{% trans 'Search' %}"/>
            </div>
        </div>
   </div>
-->
{% endblock %}
