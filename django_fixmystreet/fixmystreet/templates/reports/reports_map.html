{% extends "base.html" %}
{% load i18n %}
{% load tags %}
{% block title %}{% trans "Reports for" %} {{entity.name}}{% endblock %}
{% block css %}
{{ block.super }}

{% endblock %}

{% block meta %}
{{ block.super }}
<meta property="og:title" content="{% trans 'Reports for' %} {{entity.name}}" />
<meta property="og:description" content="{% trans 'Meta description for list page' %}" />
{% endblock %}

{% block script %}
{{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL}}js/search.js"></script>

{% block script_map %}
{{ block.super }}
<script>
var NEXT_PAGE_URL = '{% url "report_verify" %}';

var zipcodes = new Object();

{% for zip in zipcodes %}
    zipcodes[{{zip.code}}] = new Object();
    zipcodes[{{zip.code}}].participation = {{ zip.commune.active|yesno:"true,false" }};
    zipcodes[{{zip.code}}].phone = " {{zip.commune.phone}} ";
    zipcodes[{{zip.code}}].commune = "{{zip.commune.name}}";
{% endfor %}

$(function(){
    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    WMS_SERVICE_URL
    });
    var markers = [];

    // Layer switcher
    fms.currentMap.map.addControl(new OpenLayers.Control.LayerSwitcher({'div':OpenLayers.Util.getElement('layerswitcher')}));

    window.onload = function() {

        var statusToggleCreated    = document.getElementById('statusToggleCreated');
        var statusToggleInProgress = document.getElementById('statusToggleInProgress');
        var statusToggleClosed     = document.getElementById('statusToggleClosed');

        function applyFilter() {
            // Remove all popups
            while(fms.currentMap.map.popups.length) {
                 fms.currentMap.map.removePopup(fms.currentMap.map.popups[0]);
            }

            var value = this.getAttribute('value');

            if(this.checked){
                fms.statusFilter.push(value);
            }
            else {
                var i = fms.statusFilter.indexOf(value);
                if(i != -1) {
                    fms.statusFilter.splice(i, 1);
                }
            }

            // Apply filter
            fms.filterMapWithStatus();
        }
        statusToggleCreated.addEventListener('change', applyFilter);
        statusToggleInProgress.addEventListener('change', applyFilter);
        statusToggleClosed.addEventListener('change', applyFilter);

        // Init map with all reports
        fms.statusFilter = ['created', 'in_progress', 'closed'];
        fms.filterMapWithStatus(function () {
            var mapLoading = document.getElementById('map-loading');
            mapLoading.parentNode.removeChild(mapLoading);
        });
    }
});

// Override some function from search.js
function cleanMap() {
    // Remove all popups
    while(fms.currentMap.map.popups.length) {
         fms.currentMap.map.removePopup(fms.currentMap.map.popups[0]);
    }

    // Remove all features
    if (fms.currentMap.homepageMarkersLayer) {
        fms.currentMap.homepageMarkersLayer.destroyFeatures();
    }

    // Hide results
    $proposalContainer = $('#proposal-container');
    $proposalContainer.slideUp();
}

</script>
{% endblock %}
{% endblock %}

{% block map %}
<div class="row map-big">
    {% include "_map_search.html" with satus_filter=True search_report=True %}
</div>
{% endblock %}

{% block content %}
{% endblock %}
