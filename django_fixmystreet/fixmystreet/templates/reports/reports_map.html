{% extends "base.html" %}
{% load i18n %}
{% load tags %}
{% block title %}{% trans "Reports for" %} {{entity.name}}{% endblock %}
{% block css %}
{{ block.super }}

{% endblock %}

{% block meta %}
{{ block.super }}
<meta property="og:title" content="{% trans 'Reports for' %} {{entity.name}}" />
<meta property="og:description" content="{% trans 'Meta description for list page' %}" />
{% endblock %}

{% block script %}
{{ block.super }}

{% block script_map %}
{{ block.super }}
<script>
$(function(){
    var defaultX = 148838.00741428943;
    var defaultY = 171086.0720425099;

    {% if reports.0 %}
        defaultX = {{reports.0.point.x}}
        defaultY = {{reports.0.point.y}}
    {% endif %}


    // $('#map-bxl').fmsMap();
 //    $('#map-bxl').fmsMap('highlightArea', '{{ entity.feature_id }}');

    // {% for report in reports %}
    // $('#map-bxl').fmsMap('addReport',  {{ report.to_JSON|dict_to_json|safe }}, {{ forloop.counter }});
    // {% endfor %}

    // $('#map-bxl').bind('reportselected',function(evt, point, report){
    //     window.location.assign('{{report.get_absolute_url}}');
    // });

    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    WMS_SERVICE_URL,
        origin:{
            x: defaultX,
            y: defaultY
        }
    });
    var reportJSON;
    var markers = [];

    fms.filterMapWithStatus();

    // Layer switcher
    fms.currentMap.map.addControl(new OpenLayers.Control.LayerSwitcher({'div':OpenLayers.Util.getElement('layerswitcher')}));

    window.onload = function() {

        var statusToggleCreated    = document.getElementById('statusToggleCreated');
        var statusToggleInProgress = document.getElementById('statusToggleInProgress');
        var statusToggleClosed     = document.getElementById('statusToggleClosed');

        function applyFilter() {

            var value = this.getAttribute('value');

            if(this.checked){
                fms.statusFilter.push(value);
            }
            else {
                var i = fms.statusFilter.indexOf(value);
                if(i != -1) {
                    fms.statusFilter.splice(i, 1);
                }
            }

            // Apply filter
            fms.filterMapWithStatus();
        }
        statusToggleCreated.addEventListener('change', applyFilter);
        statusToggleInProgress.addEventListener('change', applyFilter);
        statusToggleClosed.addEventListener('change', applyFilter);
    }
});

// Search a ticket number
(function() {

    var $searchTicketForm = $('#search-ticket-form');

    $searchTicketForm.submit(function(event){
        event.preventDefault();
        var searchValue = $('#input-ticket-search').val();

        if (searchValue && searchValue.length > 0) {
            //Get current language
            var currentLng = 'en';
            if (window.location.href.indexOf('/nl/') != -1) {
                currentLng = 'nl';
            } else if (window.location.href.indexOf('/fr/') != -1) {
                currentLng = 'fr'
            }
            if (window.location.href.indexOf('pro') != -1) {
                window.location = "/"+currentLng+"/pro/report/search?report_id="+searchValue;
            } else {
                window.location = "/"+currentLng+"/report/search?report_id="+searchValue;
            }
        }
    });

})(document);

</script>
{% endblock %}

{% endblock %}

{% block map %}
    <div class="container">
        <div class="row">
            <div class="span12">
                <article id="map" class="map-big">

                    <div id="searchContainer">
                        <div id="newReport">
                            <div class="row">
                                <div class="span12">
                                    <div id="search-form" class="block highlighted">
                                        <form id="search-address-form" class="form-inline search-form">
                                            <div id="address-search-div">
                                                <!--h2>{% trans "Enter the address where the incident is:" %}</h2-->
                                                <input id="input-search" class="input-xxlarge" type="search" name="q" {% if location %}value="{{location}}"{% endif %} placeholder="{% trans 'Street name, Street number...' %}" />
                                                <input id="input-streetnumber"  placeholder="n°" class="input-mini" type="search" />
                                                <select id="input-ward" class="input-large" name="ward">
                                                    <option value="">{% trans "All communes..." %}</option>
                                                    {% for zip in zipcodes %}
                                                        <option value={{zip.code}}>{{zip.code}} {{zip.name}}</option>
                                                    {% endfor %}
                                                </select>
                                                <input id="widget-search-button" class="btn" type="submit" name="submit" value="{% trans 'Rechercher' %}" disabled>
                                            </div>
                                        </form>

                                        <form id="search-ticket-form" class="form-inline" action="{% url 'search_ticket' %}">
                                            <input id="input-ticket-search" class="input-large" type="search" name="q" {% if location %}value="{{location}}"{% endif %} placeholder="{% trans 'Ticket number...' %}" />
                                            <input id="widget-search-ticket-button" class="btn" type="submit" name="submit" value="{% trans 'Access Ticket' %}">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Results -->
                        <div>
                            <p id="proposal-message" class="hide"> </p>
                            <div id="proposal-container" class="inline" hidden>
                                <h3 class="numberResultsContainer"><span id="numberResults"></span> result(s)</h3>
                                <ul id="proposal" ></ul>
                                <p><button id="previousResults" hidden><</button> <button id="nextResults" hidden>></button></p>
                            </div>
                        </div>

                    </div>

                    <div id="layerswitcher" class="olControlLayerSwitcher" style="z-index:999;">
                        <div class="layersDiv">
                            <div class="dataLayersDiv">
                                <input type="checkbox" id="statusToggleCreated" value="created">
                                <label>{% trans 'Created' %}</label>
                                <br>
                                <input type="checkbox" id="statusToggleInProgress" value="in_progress">
                                <label>{% trans 'In progress' %}</label>
                                <br>
                                <input type="checkbox" id="statusToggleClosed" value="closed">
                                <label>{% trans 'Closed' %}</label>
                            </div>
                        </div>

                    </div>

                    <div id="copyright-urbis">Realized by means of Brussels UrbIS®©</div>

                </article>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="">
<!--
    <div class='span4'>
        <form action="{% url 'search_ticket' %}" class="block highlighted" id="search_by_ticket_nr">
            <h2>{% trans "Search by ticket number:" %}</h2>
            <div class="form-search">
                <input id="input-search" type="search" name="report_id" placeholder="{% trans 'Ticket number' %}">
                <input type="submit" class="btn" id="filterReports" value="{% trans 'Search' %}"/>
            </div>
        </div>
   </div>
-->
{% endblock %}
