{% extends "base.html" %}
{% load i18n tags %}
{% block title %}{{report.secondary_category.name}} {{report.secondary_category.secondary_category_class.name.lower}} {{report.category.name.lower}} {% trans 'in' %} {{report.responsible_entity.name}}{% endblock %}

{% block script %}
{{ block.super }}


<meta name="title" property="og:title" content="{{report.secondary_category.name}} {{report.secondary_category.secondary_category_class.name.lower}} {{report.category.name.lower}} {% trans 'in' %} {{report.responsible_entity.name}}" />
<meta name="description" property="og:description" content="{% trans 'Signalez tout type d incident :' %} {{report.secondary_category.name.lower}} {{report.secondary_category.secondary_category_class.name.lower}} {{report.category.name.lower}} {% trans 'in' %} {{report.responsible_entity.name}} {% trans 'sur FixMyStreet qui identifiera alors le service public en charge de le traiter. '%}" />
{% addthis_scripts %}
<script src="{{ STATIC_URL }}js/attachmentForms.js"></script>
<script>
/******************************/
/* QUERY READY INITIALIZATION */
/******************************/
$(function(){
	// $('#map-bxl').fmsMap({
	// 	origin:{
	// 		x:{{ report.point.x }},
	// 		y:{{ report.point.y }}
	// 	}
	// });
	// $('#map-bxl').fmsMap('addReport', {{report.to_JSON|dict_to_json|safe}});
    // $("#dialogMarkAsDone").dialog({
    //     modal: true,
    //     autoOpen:false,
    //     width:'auto',
    //     resizable: false
    // });
    $("#divMarkAsDone").hide();
    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: GEOSERVER_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    GEOSERVER_URL + '/geoserver/wms',
        origin:{
            x:{{ report.point.x }},
            y:{{ report.point.y }}
        }
    });

    fms.currentMap.addReport({{ report.to_JSON|dict_to_json|safe }});
});
function setFileCreationDate(){
    var file = document.getElementById('id_file').files[0];
    var file_creation_date = new Date(""+file.lastModifiedDate);
    var dateString = file_creation_date.getFullYear() + "-"+ (file_creation_date.getMonth()+1) + "-" + file_creation_date.getDate()+ " " + file_creation_date.getHours()+":"+file_creation_date.getMinutes();

    $("[name='file_creation_date']").val(dateString);
}

function markAsDone(){
    $("#divMarkAsDone").show();
    $('#id_mark_as_done_motivation').val("This is the initial text that needs to be defined. It's a suggestion for the gestionnaire. He can be edited as needed.")

    // window.location = '{% url report_update report.id %}?is_fixed=True';
}
</script>
{% endblock %}
{% block css %}

{{block.super}}

<!-- ##################### -->
<!-- # SPECIFIC CSS ZONE # -->
<!-- ##################### -->

<style type="text/css" media="screen">
    #update-header {
        float: left;
        width: 100%;
    }

    #update-title {
        float: left;
        width: 48%;
    }

    #update-email-me {
        float: right;
        width: 48%;
        text-align: right;
        margin-top: 4px;
    }
</style>
{% endblock %}
{% block content %}
<div id="divMarkAsDone" class="block highlighted">
<form id="dialogMarkAsDone" title="Please enter more information about marking the report as done" action="{% url report_update report.id %}?is_fixed=True" method="post" >
    <table>
        <tr>
                {{ mark_as_done_form.as_p }}
            
        </tr>
        <tr>
            <td>
                <input type="button" class="btn" style="float:left;" value="{% trans 'Cancel'%}" onclick="javascript:$('#divMarkAsDone').hide();"/>
            </td>
            <td>
                <input type="submit" class="btn" style="float:right;" value="{% trans 'Confirm'%}"/>
            </td>
        </tr>
    </table>
</form>
</div>

<article id="map"></article>
<!-- ######################### -->
<!-- # MAIN CONTENT DEFINITION -->
<!-- ######################### -->
<div id="page_content_container">

{% block pageHeader %}
<h1>
    <!-- ########################### -->
    <!-- # DISPLAY REPORT CATEGORY # -->
    <!-- ########################### -->
       
 	<div style="float:right;margin-top:-23px">
        	<table class="reportActionButtons">
			<tr>
				{% if report.is_in_progress %}
				<td>
                    {% if not report.status == report.SOLVED %}
					<button onclick="markAsDone();" class="saveFormButton" style="font-size: 0.4em;margin-top: 0px;width:100%;">{% trans 'Mark as done' %}</button>
                    {% else %}
                    <button onclick="" class="saveFormButton" disabled style="font-size: 0.4em;margin-top: 0px;width:100%;">{% trans 'Mark as done' %}</button>
                    <p style="font-size: 0.3em">{% trans 'This report is already marked as done' %}</p>
                    {% endif %}
				</td>
				{% endif %}
			</tr>
		</table>
	</div>
</h1>
    {% endblock %}

	<div class="overview_div_left">
        <h1>{% trans "Report Ticket" %}: {{report.get_ticket_as_string}}</h1>
		<!-- ######### -->
		<!-- IS FIXED  -->
		<!-- ######### -->
		{% if report.is_fixed %}
			<div class='is_fixed'>{% trans "This problem has been fixed." %}</div>
		{% endif %}

		<div id='report-body'>

		<p>{{report.description|linebreaks}}</p>

		<!-- ################### -->
		<!-- REPORT CREATOR ZONE -->
		<!-- ################### -->
		<p class="author-sign">
		{% if report.citizen %}
	                {% blocktrans with on=report.created|date %}
        	        	Posted on <strong>{{on}}</strong>
                	{% endblocktrans %}
	 	{% else %}
                        {% blocktrans with by=report.created_by.username on=report.created|date mail=report.created_by.email %}
                        Posted by <strong><a href="mailto:{{mail}}">{{by}}</a></strong> on <strong>{{on}}</strong>
                        {% endblocktrans %}
                        (tel:{{report.created_by.fmsuser.telephone}})
		{% endif %}
            </p>


	<!-- ################## -->
	<!-- REPORT STATUS ZONE -->
	<!-- ################## -->
            <table id='report-status'>
                <tr>
                    <th>{% trans "Location:" %}</th>
                    <td>{{report.address}}, {{report.address_number}} ({{report.postalcode}} {{report.ward.name}})</td>
                </tr>
                <tr>
                    <th>{% trans "Category:" %}</th>
                    <td>{{report.display_category}}</td>
                </tr>
            </table>


	    <!-- ################# FILES ############### -->
	    <!-- ################# FILES ############### -->
	    <!-- ################# FILES ############### -->
        <h4>{% trans "Photos and files" %}</h4>
	    {% if report.active_files %}
            
            <div id="report_updates">
                <table id="extraFilesTable">
                    {% for file in report.active_files.all %}
		    {% if file.is_public %} <!-- PUBLIC? -->
                    <tr>
                        <td class="annexesFirstTD">
                    <div class="report_update">
                        {% if file.file %}
                                
                                        <!--img style="max-width:390px;max-heigth:390px" src='{{ file.file.url }}'/-->

                                        {% if file.is_image %}
                                                <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-jpeg.png' width="48px" height="48px"/></a>
                                        {% endif %}
                                        {% if file.is_pdf %}
                                                <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-pdf.png' width="48px" height="48px"/></a>
                                        {% endif %}
                                        {% if file.is_word %}
       <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-doc.png' width="48px" height="48px"/></a>
                                        {% endif %}
                                        {% if file.is_excel %}
                                                <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-excel.png' width="48px" height="48px"/> </a>
                                        {% endif %}

                                <div class="update_text">
                                    {{file.title}}:
                                    {% blocktrans with by=file.created_by.fmsuser.get_display_name on=file.created|date %}
                                    Posted by <strong>{{by}}</strong> on <strong>{{on}}</strong>
                                    {% endblocktrans %}
                                </div>
                        {% endif %}
                    </div>
                </td>
		</tr>
		{% endif %}
		{% endfor %}
        {% if report.is_in_progress %}
		</table>
        <!-- ############################################# -->
        <!-- # ONLY AVAILABLE WHEN REPORT IS IN PROGRESS # -->
        <!-- ############################################# -->
        <div id="addFileDiv">
        <a onclick="toggleFileForm();"><img src="{{STATIC_URL}}images/plus-button.png">  {% trans "Add a file" %}</a>
            <form id="fileForm" enctype="multipart/form-data" action="{% url report_update report.id %}" method="post">
            <table id="report_form" class="form">
                {{file_form.as_table}}
                <tr>
                            <td></td>
                            <td>
                                    <p style="float:left;">
                                    <input type="hidden" name="form-type" value="file-form"/>
                                    <input type="submit" class='big_button' value="{% trans 'Add' %}" onclick="setFileCreationDate();setTimeout('toggleFileForm()',200);"/>
                                    <input type="button" class='big_button' value="{% trans 'Cancel' %}" onclick="toggleFileForm();"/>
                                    <input type="hidden" name="file_creation_date"/>
                                </p>
                            </td>
                            </tr>
            </table>
            </form>
        </div>
        {% endif %}
       </div>
	{% endif %}





	    <!-- ################# COMMENTS ############### -->
	    <!-- ################# COMMENTS ############### -->
	    <!-- ################# COMMENTS ############### -->

        <h4>{% trans "Comments" %}</h4>
	    {% if report.active_comments %}
            <div id="report_updates">
                <table class="extraCommentsTable">
                {% for comment in report.active_comments.all %}
		    {% if comment.is_public %}
                	<tr>
                    	<td class="annexesFirstTD">
                		<div class="report_update">
                    			<p>{{comment.text}}</p>
                                {% blocktrans with by=comment.created_by.fmsuser.get_display_name on=comment.created|date %}
                                Posted by <strong>{{by}}</strong> on <strong>{{on}}</strong>
                                {% endblocktrans %}
                		</div>
            		</td>
			</tr>
		    {% endif %}
		{% endfor %}
		</table>

	</div>
	{% endif %}
    {% if report.is_in_progress %}
        <!-- ############################################# -->
        <!-- # ONLY AVAILABLE WHEN REPORT IS IN PROGRESS # -->
        <!-- ############################################# -->
        <div id="addCommmentDiv">
            <a onclick="toggleCommentForm();"><img src="{{STATIC_URL}}images/plus-button.png">  {% trans "Add a comment" %}</a>
                    
            <form id="commentForm" enctype="multipart/form-data" action="{% url report_update report.id %}" method="post">
            <table id="report_form" class="form">
                {{comment_form.as_table}}
                <tr>
                            <td></td>
                            <td>
                                    <p style="float:left;">
                                    <input type="hidden" name="form-type" value="comment-form"/>
                                    <input type="submit" class='big_button' value="{% trans 'Add' %}" onclick="setTimeout('toggleCommentForm()',200);"/>
                                    <input type="button" class='big_button' value="{% trans 'Cancel' %}" onclick="toggleCommentForm();"/>
                                    </p>
                            </td>
                        </tr>
            </table>
            </form>
            </div>
          {% endif %}
            <!-- If the status allow such interactions -->
			 <a href="" onclick="window.location = '{% url report_pdf report.id 0 %}'" ><img src="{{STATIC_URL}}images/">  {% trans 'report pdf public' %}</a>
            <div id="more-actions">
                <p><a href='{% url flag_report report.id %}'>{% trans "Offensive? Unsuitable? Tell us" %}</a></p>
            </div>
		</div>
	</div>
    <div class="overview_div_right">
        <!-- ################ -->
        <!-- SUBSCRIBER BLOCK -->
        <!-- ################ -->
        {% trans "Subscribers:" %} <b>{{report.subscriptions.count}}</b><br/>
        {% if not report.is_closed and not subscribed %}
            <form action="{% url subscribe report.id %}">
                <p class="required"><input type="text" value="" placeholder="Your Email" name="citizen_email" /></p>
                <input type="submit" class="btn" value="{% trans "Subscribe" %}" />
            </form>
        {% endif %}
    </div>
</div>

{% endblock %}
