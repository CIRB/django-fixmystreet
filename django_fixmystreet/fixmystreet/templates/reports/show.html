{% extends "base.html" %}
{% load i18n %}
{% load tags %}

{% block title %}{{report.title}}{% endblock %}
{% block script %}
{{ block.super }}
<meta property="og:title" content="{{ report.title }}" />
<meta property="og:description" content="{{ report.description }}" />
<meta property="og:image" content="{{ MEDIA_URL }}{{ report.photo }}" />
{% addthis_scripts %}
{% map_scripts %}
<script>
$(function(){
	$('#map-bxl').fmsMap({ 
		origin:{
			x:{{ report.point.x }},
			y:{{ report.point.y }} 
		}
	});
	$('#map-bxl').fmsMap('addReport', {% report_to_json report %});
});
function subscribe() {
	window.location = "{% url subscribe report.id %}?citizen_email="+$('#citizen_email').val();
}
</script>
{% endblock %}
{% block css %}
<style type="text/css" media="screen">
    #update-header {
        float: left;
        width: 100%;
    }
    
    #update-title {
        float: left;
        width: 48%;
    }
    
    #update-email-me {
        float: right;
        width: 48%;
        text-align: right;
        margin-top: 4px;
    }
</style>
{% endblock %}
{% block content %}
<div id="page_content_container">
    {% if not report.is_fixed and report.is_confirmed %}
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
        <a href="http://www.addthis.com/bookmark.php?v=250&pub=xa-4a620b09451f9502" class="addthis_button_compact">Share</a>
        <span class="addthis_separator">|</span>
        <a class="addthis_button_facebook"></a>
        <a class="addthis_button_myspace"></a>
        <a class="addthis_button_google"></a>
        <a class="addthis_button_twitter"></a>
    </div>
	<!-- AddThis Button END -->
    {% endif %}

    <h1>{{report.title}}</h1>
	<div id="leftcol">    
		{% if report.is_fixed %}
		<div class='is_fixed'>{% trans "This problem has been fixed." %}</div>
		{% endif %}

		<div id='report-body'>
            <div id='report-subscribers'>
                {% trans "Subscribers:" %} <b>{{report.reportsubscription_set.count}}</b><br/>					
                {% if not report.is_closed %}
                    <input type="text" value="" placeholder="Your Email" id="citizen_email" />
		    <br/>
                    {% if not subscribed %}
                    <a href="javascript:subscribe()">{% trans "Subscribe" %}</a>
                    {% endif %}
                {% endif %}
            </div>

			<p>{{report.description|linebreaks}}</p>

			{% if report.photo  %}
			<center><img src='{{ report.photo.url }}'/></center>
		    {% endif %}

			<p class="author-sign">
                {% blocktrans with by=report.author.get_full_name on=report.created_at|date %}
                Posted by <strong>{{by}}</strong> on <strong>{{on}}</strong>
                {% endblocktrans %}
            </p>


            <table id='report-status'>			
                <tr>
                    <th>{% trans "Location:" %}</th>
                    <td>{{report.address}} ({{report.postalcode}} {{report.ward.name}})</td>
                </tr>
                <tr>
                    <th>{% trans "Category:" %}</th>
                    <td>{{report.category.name}} / {{report.secondary_category.name}}</td>
                </tr>
            </table>


	    <!-- ################# FILES ############### -->
	    <!-- ################# FILES ############### -->
	    <!-- ################# FILES ############### -->
	    {% if report.get_files %}
            <h3>{% trans "Extra files" %}</h3>
            <div id="report_updates">
                <table id="extraFilesTable">
                    {% for file in report.get_files %}
		    {% if file.validated %} <!-- PUBLIC? -->
                    <tr>
                        <td class="annexesFirstTD">
                    <div class="report_update">
                        {% if file.file %}
                                <center>
                                        <!--img style="max-width:390px;max-heigth:390px" src='{{ file.file.url }}'/-->
                                        {{file.title}}
                                        {% if file.is_image %}
                                                <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-jpeg.png' width="48px" height="48px"/></a>
                                        {% endif %}
                                        {% if file.is_pdf %}
                                                <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-pdf.png' width="48px" height="48px"/></a>
                                        {% endif %}
                                        {% if file.is_word %}
       <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-doc.png' width="48px" height="48px"/></a>
                                        {% endif %}
                                        {% if file.is_excel %}
                                                <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-png.png' width="48px" height="48px"/> </a>
                                        {% endif %}
                                </center>
                        {% endif %}
                    </div>
                </td>
		</tr>
		{% endif %}
		{% endfor %}
		</table>
	</div>
	{% endif %}





	    <!-- ################# COMMENTS ############### -->
	    <!-- ################# COMMENTS ############### -->
	    <!-- ################# COMMENTS ############### -->
	    {% if report.get_comments %}
            <h3>{% trans "Extra comments" %}</h3>
            <div id="report_updates">
                <table class="extraCommentsTable">
                {% for comment in report.get_comments %}
		{% if comment.validated %} 
                	<tr>
                    	<td class="annexesFirstTD">
                		<div class="report_update">
                    			<h4>{{comment.title}}</h4>
                    			<p>{{comment.text}}</p>
                		</div>
            		</td>
			</tr>
		{% endif %}
		{% endfor %}
		</table>
	</div>
	{% endif %}


            <!-- If the status allow such interactions -->


			<div id="more-actions">
				<p><a href='{% url flag_report report.id %}'>{% trans "Offensive? Unsuitable? Tell us" %}</a></p>
			</div>
		
			{% if report.reportupdate_set.all %}
			<h3>{% trans "Updates" %}</h3>
			<div id="report_updates">
				{% for update in report.reportupdate_set.all %}
				<div class="report_update">
					<p>{{update.desc}}</p>
					{% if update.is_fixed %}<strong class="fixed_msg">{% trans "This problem has been fixed." %}</strong>{% endif %}
					<p class="author-sign">{% blocktrans with by=update.author.get_full_name on=update.created_at|date %}Posted by <strong>{{by}}</strong> on <strong>{{on}}</strong>{% endblocktrans %}</p>
				</div>
				{% endfor %}
			</div>
			{% endif %}

			{% if not report.is_closed %}
			<h2>{% trans "Provide an update" %} </h2>
			<p>{% trans "The status of this report has changed? Thank you let us know by filling this form." %}</p>
			<form action="{% url report_update report.id %}" method="post">
				<table id="report_form" class="form">
					{{update_form.as_table}}
					<tr><td></td><td><input type="checkbox" id="is_fixed" name="is_fixed" value="1">{% trans "This problem has been fixed." %}</td></tr>
					<tr>
                        <td></td>
                        <td>
                            <p>
                                <input type="submit" class='big_button' value="{% trans 'Submit' %}" />
                            </p>
                            <p class="login-bar">
                                {% trans 'You are not connected, please login to submit your report' %}
                            </p>
                        </td>
                    </tr>
				</table>
			</form>
			{% endif %}
		</div>
	</div>
	<div id="rightcol">
     	<div id="map-bxl" ></div>
    </div>
</div>
	
{% endblock %}
