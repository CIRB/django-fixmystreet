{% extends "base.html" %}
{% load i18n tags %}
{% block title %}{{report.secondary_category.name}} {{report.secondary_category.secondary_category_class.name.lower}} {{report.category.name.lower}} {% trans 'in' %} {{report.responsible_entity.name}}{% endblock %}

{% block script %}
{{ block.super }}


<meta name="title" property="og:title" content="{{report.secondary_category.name}} {{report.secondary_category.secondary_category_class.name.lower}} {{report.category.name.lower}} {% trans 'in' %} {{report.responsible_entity.name}}" />
<meta name="description" property="og:description" content="{% trans 'Signalez tout type d incident :' %} {{report.secondary_category.name.lower}} {{report.secondary_category.secondary_category_class.name.lower}} {{report.category.name.lower}} {% trans 'in' %} {{report.responsible_entity.name}} {% trans 'sur FixMyStreet qui identifiera alors le service public en charge de le traiter. '%}" />
{% addthis_scripts %}
<script src="{{ STATIC_URL }}js/attachmentForms.js"></script>
<script>
/******************************/
/* QUERY READY INITIALIZATION */
/******************************/
$(function(){
    // $('#map-bxl').fmsMap({
    //     origin:{
    //         x:{{ report.point.x }},
    //         y:{{ report.point.y }}
    //     }
    // });
    // $('#map-bxl').fmsMap('addReport', {{report.to_JSON|dict_to_json|safe}});
    // $("#dialogMarkAsDone").dialog({
    //     modal: true,
    //     autoOpen:false,
    //     width:'auto',
    //     resizable: false
    // });
    $("#divMarkAsDone").hide();
    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    URBIS_URL + '/geoserver/wms',
        origin:{
            x:{{ report.point.x }},
            y:{{ report.point.y }}
        }
    });

    fms.currentMap.addReport({{ report.to_JSON|dict_to_json|safe }}, 1, {% if BACKOFFICE %}true{%else%}false{%endif%});
});
function setFileCreationDate(){
    var file = document.getElementById('id_file').files[0];
    var file_creation_date = new Date(""+file.lastModifiedDate);
    var dateString = file_creation_date.getFullYear() + "-"+ (file_creation_date.getMonth()+1) + "-" + file_creation_date.getDate()+ " " + file_creation_date.getHours()+":"+file_creation_date.getMinutes();

    $("[name='file_creation_date']").val(dateString);
}

function markAsDone(){
    // $("#divMarkAsDone").show();
    $('#id_mark_as_done_motivation').val("This is the initial text that needs to be defined. It's a suggestion for the gestionnaire. He can be edited as needed.")

    // window.location = '{% url report_update report.id %}?is_fixed=True';
}
</script>
{% endblock %}
{% block css %}

{{block.super}}

<!-- ##################### -->
<!-- # SPECIFIC CSS ZONE # -->
<!-- ##################### -->

<style type="text/css" media="screen">
    #update-header {
        float: left;
        width: 100%;
    }

    #update-title {
        float: left;
        width: 48%;
    }

    #update-email-me {
        float: right;
        width: 48%;
        text-align: right;
        margin-top: 4px;
    }
</style>
{% endblock %}
{% block content %}



<div id="divMarkAsDone" class="modal hide fade" role="dialog">
    <div class="modal-body">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <form id="dialogMarkAsDone" title="Please enter more information about marking the report as done" action="{% url report_update report.id %}?is_fixed=True" method="post" >
            {% csrf_token %}
            {{ mark_as_done_form.as_p }}

            <input type="button" class="btn"  value="{% trans 'Cancel'%}" data-dismiss="modal" aria-hidden="true"/>

            <input type="submit" class="btn"  value="{% trans 'Confirm'%}"/>
        </form>
    </div>
</div>

<article id="map"></article>
<!-- ######################### -->
<!-- # MAIN CONTENT DEFINITION -->
<!-- ######################### -->
<div id="page_content_container">

{% block pageHeader %}

    {% endblock %}


<div class="overview_div_left">
    <h2>{% trans "Report Ticket" %} {{ report.get_ticket_as_string }}
        <div style="float:right;margin-top:-23px">
            <table class="reportActionButtons">
            <tr>
                {% if report.is_in_progress %}
                <td>
                    {% if not report.status == report.SOLVED %}
                    <a href="#divMarkAsDone" onclick="markAsDone();" class="btn" data-toggle="modal" >{% trans 'Mark as done' %}</a>
                    {% else %}
                    <button onclick="" class="btn" disabled style="font-size: 0.4em;margin-top: 0px;width:100%;">{% trans 'Mark as done' %}</button>
                    <p style="font-size: 0.3em">{% trans 'This report is already marked as done' %}</p>
                    {% endif %}
                </td>
                {% endif %}
            </tr>
        </table>
    </div>
    </h2>
    <!-- ######### -->
    <!-- IS FIXED  -->
    <!-- ######### -->
    {% if report.is_created %}
    <div class='is_fixed'>{% trans "This incident is not validated." %}</div>
    {% endif %}
    {% if report.is_closed %}
    <div class='is_fixed'>{% trans "This incident has been closed." %}</div>
    {% endif %}

    <div id='report-body'>
        <p>
            {% if report.description %}
                {{report.description|linebreaks}}
            {% endif %}
        </p>
        <!-- ################### -->
        <!-- REPORT CREATOR ZONE -->
        <!-- ################### -->
        <p class="author-sign">
        {% if report.citizen %}
                    {% blocktrans with on=report.created %}
                        Posted on <strong>{{on}}</strong>
                    {% endblocktrans %}
         {% else %}

                        {% blocktrans with by=report.created_by.username on=report.created mail=report.created_by.email %}
                        Posted by <strong><a href="mailto:{{mail}}">{{by}}</a></strong> on <strong>{{on}}</strong>
                        {% endblocktrans %}
                        (tel:{{report.created_by.fmsuser.telephone}})
        {% endif %}
        </p>


        <!-- ################## -->
        <!-- REPORT STATUS ZONE -->
        <!-- ################## -->
        <table id='report-status'>
            <tr>
                <th>{% trans "Location:" %}</th>
                    <td>{{report.address}}, {{report.address_number}} ( {{report.responsible_entity.name}} ({{report.postalcode}}))</td>
            </tr>
            <tr>
                <th>{% trans "Category:" %}</th>
                <td>{{report.display_category}}</td>
            </tr>
            <tr>
                <th>{% trans "Status:" %}</th>
                    <td>{{ report.get_status_display }}<img src="{{STATIC_URL}}{{report.get_marker}}" style="max-width:30px;"></td>
            </tr>
        </table>


        <!-- ################# FILES ############### -->
        <!-- ################# FILES ############### -->
        <!-- ################# FILES ############### -->
        {% if report.active_files %}
        <br/>
	<h4>{% trans "Photos and files" %}</h4>
        <div id="report_updates">
            <table id="extraFilesTable">
            {% for file in report.active_files.all %}
                {% if file.is_public %} <!-- PUBLIC? -->
                <tr>
                    <td class="annexesFirstTD">
                        <div class="report_update">
                        {% if file.file %}

                                <!--img style="max-width:390px;max-heigth:390px" src='{{ file.file.url }}'/-->

                                {% if file.is_image %}
                                        <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='{{file.file.url}}' width="48px" height="48px"/></a>
                                {% endif %}
                                {% if file.is_pdf %}
                                        <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-pdf.png' width="48px" height="48px"/></a>
                                {% endif %}
                                {% if file.is_word %}
                                        <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-doc.png' width="48px" height="48px"/></a>
                                {% endif %}
                                {% if file.is_excel %}
                                        <a href="{{ file.file.url }}" ><img style="max-width:390px;max-heigth:390px" src='/static/images/icon-excel.png' width="48px" height="48px"/> </a>
                                {% endif %}

                            <div class="update_text">
				{{file.title}}
				<br/>
	                        <strong>{% trans 'Posted By' %}: </strong>
        	                {% if file.created_by %}
                	                {{file.created_by.fmsuser.get_display_name}}
                        	        (mail:{{file.created_by.fmsuser.email}}, tel:{{file.created_by.fmsuser.telephone}})
                        	{% else %}
                                	{% trans 'Anonymous '%}
                        	{% endif %}
				<br/>
				{% trans 'On' %}: {{file.created}}
                                {% if file.is_image %}
					{% if file.file_creation_date %}
						<br/>
						{% trans 'Creation Date' %}:
						{{file.file_creation_date}}
  					{% endif %}
  				{% endif %}
                            </div>
                        {% endif %}
                        </div>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
            </table>
        </div>
        {% endif %}

        <!-- ################# COMMENTS ############### -->
        <!-- ################# COMMENTS ############### -->
        <!-- ################# COMMENTS ############### -->
        {% if report.active_comments %}
        <br/>
	<h4>{% trans "Comments" %}</h4>
        <div id="report_updates">
            <table class="extraCommentsTable">
            {% for comment in report.active_comments.all %}
                {% if comment.is_public %}
                <tr>
                    <td class="annexesFirstTD">
                        <div class="report_update">
                            <p>{{comment.text}}</p>
                            {% blocktrans with by=comment.created_by.fmsuser.get_display_name on=comment.created %}
                            Posted by <strong>{{by}}</strong> on <strong>{{on}}</strong>
                            {% endblocktrans %}
                        </div>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
            </table>
        </div>
        {% endif %}

    </div><!-- report-body -->

    {% if report.is_in_progress %}
    <form enctype="multipart/form-data" method="post" action="" id="report-form" class="form-horizontal">
        {% csrf_token %}
        <!-- ############################################# -->
        <!-- # ONLY AVAILABLE WHEN REPORT IS IN PROGRESS # -->
        <!-- ############################################# -->
        <fieldset>
            <legend>Comment</legend>
            {{ comment_form.text }}
            {# comment_form.text.errors #}
        </fieldset>
        <fieldset>
            <legend>Files</legend>
            <div id="form-files">
                {{ file_formset.management_form }}
                {# file_formset.errors #}

                <div id="file-form-template">
                    <img class="thumbnail" />
                    {{ file_formset.empty_form.reportattachment_ptr }}
                    {{ file_formset.empty_form.file }}
                    {{ file_formset.empty_form.title }}
                    {{ file_formset.empty_form.file_creation_date }}
                </div>
            </div>
            <div class="file-upload-button">
                <a id="file-upload"><img src="{{STATIC_URL}}images/plus-button.png">Add file</a>
            </div>

        </fieldset>
        <p>
            <input type="submit" class='btn' value="{% trans 'Send' %}" />
        </p>
    </form>
    {% endif %}


        <!-- If the status allow such interactions -->
        <p>
            <a href="{% url report_pdf report.id 0 %}">
                <i class="icon-download" /> </i>{% trans 'report pdf public' %}
            </a>
        </p>
        <div id="more-actions">
            <p><a href='{% url flag_report report.id %}'>{% trans "Offensive? Unsuitable? Tell us" %}</a></p>
        </div>
    </div>

    {% if report.is_in_progress %}
    <div class="overview_div_right">
        <!-- ################ -->
        <!-- SUBSCRIBER BLOCK -->
        <!-- ################ -->
        {% trans "Subscribers:" %} <b>{{report.subscriptions.count}}</b><br/>
        {% if not report.is_closed and not subscribed %}
            <form action="{% url subscribe report.id %}">
                {% csrf_token %}
                <p class="required"><input type="text" value="" placeholder="Your Email" name="citizen_email" /></p>
                <input type="submit" class="btn" value="{% trans "Subscribe" %}" />
            </form>
        {% endif %}
    </div>
    {% endif %}
</div>
</div>

{% endblock %}
