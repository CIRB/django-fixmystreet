{% extends "base.html" %}

{% load i18n tags %}

{% block base %}
<base href="{% if request.is_secure %}https{% else %}http{% endif %}://{{request.get_host}}" target="_blank"/>
{% endblock %}

<!-- ############################################################## -->
<!-- #######################JAVASCRIPT IMPORTS #################### -->
<!-- ############################################################## -->
<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}OpenLayers-2.11/OpenLayers.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/proj4js/engine/proj4js-compressed.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/proj4js/defs/EPSG31370.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/geolocation.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/fixmystreetmap.js"></script>

<!-- ############################################################## -->
<!-- #######################JQUERY INIT METHOD #################### -->
<!-- ############################################################## -->
{% block script %}
{{ block.super }}
    <script>
        $(document).ready(function() {
            fms.currentMap = new fms.Map(
                'map',
                {apiLang:'nl',
                    localizeUrl: 'http://service.gis.irisnet.be/urbis/Rest/Localize/getaddressfromxy',
                    urbisUrl: 'http://geoserver.gis.irisnet.be/geoserver/wms',
                    origin: {
                    x:{{report.point.x}},
                    y:{{report.point.y}}
                    }
                });
            fms.currentMap.addReport({{ report.to_JSON|dict_to_json|safe }}, 1);
            var res = UtilGeolocation.convertCoordinatesToWGS84({{report.point.x}},{{report.point.y}});
            document.getElementById("wgs84").innerHTML="L: " + res.x + " <br/>l: "+res.y;
        });
    </script>
{% endblock %}


{% block nav %}
    {% if BACKOFFICE %}
        <img id="banner-pro" src="{{ STATIC_URL }}images/fixmystreet-pro.png" alt="{% trans 'Fix My Street Pro' %}">
    {% endif %}
{% endblock %}
{% block lng %}{% endblock %}

{% block css %}
    {{ block.super }}
    <style>
        header {
            height: 100px;
            width: auto;
            background-color: white;
        }
        body{
            width: 100%;
        }
        h2
        {
            font-size: 26px;
        }
        hr
        {
            border-color: #999;
        }
        div > p
        {
            margin-left:30px;
        }
        .p_title
        {
            margin-left: 0;
        }
        .by
        {
            font-size: x-small;
            text-align: right;
        }

        .container {
            width:700px;
        }
        .olControlZoom {
            display: none;
        }

        .block-left, .block-right {
            width: 300px;
            height: 160px;
            border: 1px solid #999;
            padding:20px;
        }
        .block-left {
            float:left;
        }
        .block-right {
            float:right;
        }

        .block-full, .report_update {
            width: 660px;
            border: 1px solid #999;
            padding:20px;
            border-radius: 0;
        }

        .report_update a {
            color: #333333;
        }

        .report_update .view-image {
            width: auto;
        }

        #banner-pro {
            position: absolute;
            bottom: 0;
            right: 30px;
            z-index: 1000000;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="map">
        <div id="copyright-urbis">Realized by means of Brussels UrbIS®©</div>
    </div>
    <!--
        Title
    -->
    <h1 style="position:relative;">
        {% if report.is_in_progress %}
            <img src="{{STATIC_URL}}{{report.get_marker}}" style="width:40px;" />
        {% else %}
            <img src="{{STATIC_URL}}{{report.get_marker}}" style="width:40px;" />
        {% endif %}
        {% trans "Report Ticket" %} {{ report.get_ticket_number }}
    </h1>

    <!--
        Status
    -->

    <div>
        {% if report.is_created %}
            <div class='is_created'>{% trans "This incident is not validated." %}</div>
        {% endif %}

        {% if report.is_refused %}
            <div class='is_created'>
                <p>{% trans "This problem has been refused." %}</p>
                {% if pro_version %}<p>{{ report.refusal_motivation }}</p>{% endif %}
            </div>
        {% endif %}

        {% if report.is_in_progress %}
            <div class="is_in_progress">{% trans "This incident is in progress." %}</div>
        {% endif %}

        {% if report.is_closed %}
            <div class='is_fixed'>{% trans "This incident has been closed." %}</div>
        {% endif %}

    </div>

    <!--
        Localisation
    -->

    <div class="block-left">
        <p class="p_title"><strong>{% trans 'Location' %}</strong></p>
        <p>{{report.address}}, {{report.address_number}} ({{report.postalcode}} {{report.get_address_commune_name}})</p>

        <p class="p_title"><strong>{% trans 'Category' %}</strong></p>
        <p>{{report.display_category}}</p>
    </div>

    <div class="block-right">
        <p class="p_title"><strong>{% trans 'Geolocation' %} ({% trans 'Lambert 72 Belgium'%})</strong></p>
        <p>L:{{report.point.x}}<br/> l:{{report.point.y}}</p>

        <p class="p_title"><strong>{% trans 'Geolocation' %} (WGS84)</strong></p>
        <p id="wgs84"></p>
    </div>

    <div style="clear:both;"></div>

    <!--
        Reporter
    -->

    <br/>
    <div class="block-left">
        <h2>{% trans 'Created'%}</h2>

        <p>
            <strong>
                {% trans 'By' %}
            </strong>

            {% if report.citizen %}
                {% if pro_version %}
                    {{report.citizen.fmsuser.get_display_name}},
                    <br/>
                    {{report.citizen.fmsuser.email}}
                    -
                    {{report.citizen.fmsuser.telephone}}
                {% else %}
                    {% trans 'a citizen' %}
                {% endif %}
            {% else %}
                {% if pro_version %}
                    {{ report.created_by.get_organisation }} {{ report.created_by.fmsuser.get_display_name }}
                {% else %}
                    {{ report.created_by.get_organisation }}
                {% endif %}
            {% endif %}
        </p>

        <p>
            <strong>
                {% trans 'on' context 'time' %}
            </strong>
            {{report.created|date}}
        </p>
    </div>


    <!--
        Responsible
    -->

    <div class="block-right">
        <h2>{% trans 'Treated'%}</h2>

        <p>
            <strong>{% trans 'By' %}</strong>

            {% if pro_version %}
                {{report.responsible_manager.first_name}} {{report.responsible_manager.last_name}} - {{report.responsible_manager.organisation.name}},
                <br/>
                {{report.responsible_manager.email}}
                -
                {{report.responsible_manager.telephone}}
            {% else %}
                {{report.responsible_manager.organisation.name}}
            {% endif %}
        </p>
    </div>

    <div style="clear:both;"></div>

    <!--
        History
    -->

    <br/>
    <div class="block-full" style="padding-top:10px;">
        <h2>{% trans 'History' %}</h2>
        {% include "reports/_activity_list.html" %}
    </div>

    <!--
        Comments
    -->

    <h2>{% trans 'Comments' %}</h2>
    {% for attachment in comments %}
        {% include "reports/_attachment.html" with attachment=attachment privacy=privacy editable=Flase %}
    {% endfor %}

    {% for attachment in files %}
        {% include "reports/_attachment.html" with attachment=attachment privacy=privacy editable=Flase %}
    {% endfor %}

    {% block footer %}{% endblock %}
{% endblock %}
