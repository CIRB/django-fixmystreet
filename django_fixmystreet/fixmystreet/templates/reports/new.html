{% extends "base.html" %}
{% load i18n tags %}
{% block title %}{% trans "New Report" %}{% endblock %}
{% block script %}
{{ block.super }}

<script src="{{ STATIC_URL }}js/attachmentForms.js"></script>
<script src="{{ STATIC_URL }}js/categorySelection.js"></script>

<meta property="og:title" content="{% trans 'New Report' %}" />
<meta property="og:description" content="{% trans 'Signalez tout type d incident. Sur FixMyStreet qui identifiera alors le service public en charge de le traiter.' %}" />
<script>
$(function(){
    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + 'service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    URBIS_URL + 'geoserver/wms',
        origin:{
            x:{{ pnt.x }},
            y:{{ pnt.y }}
        }
    });
    {% for report in reports %}
    fms.currentMap.addReport({{ report.to_JSON|dict_to_json|safe }},{{forloop.counter}});
    {% endfor %}
    fms.currentMap.addDraggableMarker({{ pnt.x }}, {{ pnt.y }});

    {% if report%}
    show_confirmation_popup();
    {% endif %}
});

function show_confirmation_popup(){
    $("#confirmation_popup").modal();
}

var available_zipcodes = {
    {% for zip in available_zips %}
    "{{zip.code}}": "{{zip.name}}"{% if not forloop.last %},{% endif %}
    {% endfor %}
}
var available_zipcodes_msg = "{% trans 'This commune does not participate' %} {% for zip in available_zips %}{{zip.name}}{% if not forloop.last %}, {% endif %}{% endfor %}"

var categories = {
    {% for category_class in category_classes %}
    "{{ category_class.id }}": {
        {% for category in category_class.categories.all %}
            "{{ category.id }}": {
                "label": "{{ category.name }}",
                "class": "{{ category.secondary_category_class.id }}",
                "public": {{ category.public|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
}


</script>

<script src="{{STATIC_URL}}js/new_report.js"></script>

{% block specific_scripts %}
<script src="{{STATIC_URL}}js/reportFormReview.js"></script>
{% endblock %}
{% endblock %}

{% block content %}
<div id="confirmation_popup" class="modal hide fade" role="dialog">
    <div class="modal-header">
        <a class="close" href="{{report.get_absolute_url}}" >&times;</a>
        <h3>{% trans 'Submit an incident:' %}</h3>
    </div>
    <div class="modal-body">
        <p><img src="" > {% trans 'Thank you! Your incident has been sent correctly to the system.' %}</p>
        {% if report %}
        <p><a href="{% url report_pdf report.id 0 %}" ><img src="" > {% trans 'Download a copy of the incident as a pdf' %}</a></p>
        {% endif %}
    </div>
    <div class="modal-footer">
        <a href="{{report.get_absolute_url}}" class="btn"> {% trans 'Continue'%}</a>
    </div>
</div>
    <article id="map">
        <div id="cursor-instructions" class="block highlighted">
            {% trans "Drag me to change my location." %}
        </div>
    </article>
    <h1>{% trans "Submitting a report" %}</h1>

    <div id="leftcol">
        {% block report_form %}
        <form enctype="multipart/form-data" method="post" action="" id="report-form" class="form-horizontal">
            <div id="required-note" class="controls lead">{% trans "* This fields are required" %}</div>

            <div class="control-group">
                <span class="control-label">{% trans "Address" %}</span>
                <div class="controls">
                    <span id="address-text"></span>
                </div>
            </div>
            <div class="control-group">
                <span class="control-label">{% trans "Commune" %}</span>
                <div class="controls">
                    <span id="postcode-text"></span>
                </div>
            </div>

            {% include "_form_twbootstrap.html" with form=report_form %}

            {% if report.status.code != '3' and report.status.code != '8' and report.status.code != '9' %}
            {# If the status allow such interactions #}
            <fieldset>
                <legend>Informations</legend>
                {% include "_form_twbootstrap.html" with form=citizen_form %}
            </fieldset>
            <fieldset>
                <legend>Comment</legend>
                {{ comment_form.text }}
                {# comment_form.text.errors #}
            </fieldset>
            <fieldset>
                <legend>Files</legend>
                <div id="form-files">
                    {{ file_formset.management_form }}
                    {# file_formset.errors #}

                    <div id="file-form-template">
                        <img class="thumbnail" />
                        {{ file_formset.empty_form.reportattachment_ptr }}
                        {{ file_formset.empty_form.file }}
                        {{ file_formset.empty_form.description }}
                    </div>
                </div>
                <p class="pull-right">
                    <button id="file-upload" class="btn">Add file</button>
                </p>
            </fieldset>
            {% endif %}
            <p>
                <input type="submit" class='btn' value="{% trans 'Send' %}" />
            </p>
        </form>
    </div>

            <div id="report_overview_table_div">
            <table class="report_overview_table">
                <tr>
                    <th>{% trans 'Location' %}</th>
                    <td id="locationView">

                    </td>
                </tr>
                <tr>
                    <th>{% trans 'Category' %}</th>
                    <td id="category1View">

                    </td>
                </tr>
                <tr>
                    <th>{% trans 'Category' %}</th>
                    <td id="category2View">

                    </td>
                </tr>
                <!--<tr>
                    <th>{% trans 'Photo' %}</th>
                    <td id="photoView">

                    </td>
                </tr>-->
                <tr>
                    <th>{% trans 'Description' %}</th>
                    <td id="descriptionView">

                    </td>
                </tr>
                <tr>
                    <th>{% trans 'Email' %}</th>
                    <td id="emailView">

                    </td>
                </tr>
                <tr>
                    <th>{% trans 'First name' %}</th>
                    <td id="firstNameView">

                    </td>
                </tr>
                <tr>
                    <th>{% trans 'Name' %}</th>
                    <td id="nameView">

                    </td>
                </tr>
            </table>
            <p>
                <input type="button" class='big_button' value="{% trans 'Edit' %}" style="float:left;" onclick="showForm();"/>
            </p>
            </div>
        {% endblock %}
     </div>
    <div id="rightcol">
        <p>{% trans "Zoom out to see more reports nearby." %}</p>
        <div class='note'>
            <p><strong>{% trans "Please Note" %} :</strong></p>
            <ul>
                <li>{% trans "Please be polite, concise and to the point." %}</li>
                <li>{% trans "Please do not be abusive - abusing the service devalues the service for all users." %}</li>
                <li>{% trans "Writing your message entirely in block capitals makes it hard to read, as does a lack of punctuation." %}</li>
                <li>{% trans "Remember that FixMyStreet is primarily for reporting physical problems that can be fixed. If your problem is not appropriate for submission via this site please contact city officials directly." %}</li>
            </ul>
            <p/>
        </div>
        <h2>
            {% trans "Nearby reports" %}
        </h2>

        {% if reports %}
            <div id='search_results'>
            {% for report in reports %}
            {% include "reports/_navigation.html" with url=report.get_absolute_url %}
            {% endfor %}
            </div>
        {% else %}
            <p>{% trans "No problems have been reported in this area." %}</p>
        {% endif %}
    </div>





    </div>
</div>
{% endblock %}
