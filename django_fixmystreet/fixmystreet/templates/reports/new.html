{% extends "base.html" %}
{% load i18n tags %}
{% block title %}{% trans "New Report" %}{% endblock %}

{% block meta %}
<meta property="og:title" content="{% trans 'New Report' %}" />
<meta property="og:description" content="{% trans 'Signalez tout type d incident. Sur fix my street qui identifiera alors le service public en charge de le traiter.' %}" />
{% endblock %}


{% block script %}
{{ block.super }}
<script src="{{ STATIC_URL }}js/attachmentForms.js"></script>
<script src="{{ STATIC_URL }}js/categorySelection.js"></script>
<script src="{{STATIC_URL}}js/new_report.js"></script>
<script src="{{ STATIC_URL }}js/jquery.exif.js"></script>

<script>
    var zipcodes = new Object();

    {% for zip in all_zips %}
    zipcodes[{{zip.code}}] = new Object();
    zipcodes[{{zip.code}}].participation = {{ zip.commune.active|yesno:"true,false" }};
    zipcodes[{{zip.code}}].phone = " {{zip.commune.phone}} ";
    zipcodes[{{zip.code}}].commune = "{{zip.commune.name}}";
    {% endfor %}

    $(function(){
        var proVersion = {{ BACKOFFICE|yesno:'true,false' }};

        $("input:checkbox").attr("value","off");
        $("input:checkbox").bind("change",function(){

            if ($(this).attr("value")!="on"){
                $(this).attr("value","on");
            }
            else {
                if($(this).attr("checked")=="checked"){
                    $(this).attr("value","on");
                    return false;
                }
                $(this).attr("value","off");
            }
        });

        $('#form-files').find('textarea').attr('placeholder',"{% trans 'Your file description' %}");
    });


    var categories = {
        {% for category_class in category_classes %}
        "{{ category_class.id }}": {
            {% for category in category_class.categories.all %}
                "{{ category.id }}": {
                    "label": "{{ category.name }}",
                    "class": "{{ category.secondary_category_class.id }}",
                    "public": {{ category.public|yesno:"true,false" }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    }
</script>
{% endblock %}

{% block map %}
<div class="container">
    <div class="row">
        <div class="span12">
            <article id="" class="verify_list">
                <div id="searchContainer">
                    <div id="instructions">
                        <div class="row">
                            <div class="span8">
                                <ol class="steps">
                                    <li class="stepOne off">{% trans "Localisation" %}</li>
                                    <li class="stepTwo on">{% trans "Description" %}</li>
                                    <li class="stepThree off">{% trans "Coordonnees" %}</li>
                                </ol>
                            </div>
                            <div>
                                <strong id="danger-risk"><a href="#"><i class="icon-danger"></i>{% trans "A big security risk to signal?" %}</a></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}

<h2  id="address-text"></h2>

<form enctype="multipart/form-data" method="post" action="" id="report-form" class="form-horizontal">

    <!-- Description -->
    <div id="description" class="" style="margin-top: 30px;">
        {% block report_form %}
            {% for field in report_form.hidden_fields %}
                {{ field }}
            {% endfor %}

            <div class="control-group">

                <label class="control-label" for="category_select">
                    <strong>{% trans 'Constatation' %}</strong>
                </label>
                <div class="controls">
                    {% input_class report_form.category 'span4' %}
                    {% input_class report_form.secondary_category 'span5' %}
                </div>
            </div>

            {% include "reports/_photo_form.html" %}

            <div class="control-group">
                <label for="add_comment" class="control-label">
                    <strong>{% trans 'Commentaire' %}</strong><br />
                    {% trans 'Votre commentaire sera validé avant publication sur le site.' %}
                </label>
                <div class="controls">
                    {% input_class comment_form.text 'fullsize_field' %}
                </div>
            </div>

        {% endblock %}

        <p>
            <button id="nextStep" class="btn pull-right" disabled>Etape suivante</button>
        </p>
    </div>


    <!-- Coordonnées -->
    <div id="coordonnees" class="span6" style="margin-top: 30px;" hidden>

        {% if citizen_form %}

            <div class="control-group">
                <label for="name" class="control-label">
                    <strong>{% trans 'Nom' %}</strong>
                </label>
                <div class="controls">
                    {% input_class citizen_form.last_name 'span6' %}
                </div>
            </div>

            <div class="control-group">
                <label for="quality" class="control-label">
                    <strong>{% trans 'Qualité' %}</strong>
                </label>
                <div class="controls">
                    {% input_class citizen_form.quality 'span6' %}
                </div>
            </div>

            <div class="control-group">
                <label for="telephone" class="control-label">
                    <strong>{% trans 'Téléphone' %}</strong>
                </label>
                <div class="controls">
                    {% input_class citizen_form.telephone 'span6' %}
                </div>
            </div>
            <div class="control-group">
                <label for="email" class="control-label">
                    <strong>{% trans 'Email' %}</strong>
                </label>
                <div class="controls">
                    {% input_class citizen_form.email 'span6' %}
                </div>
            </div>

        {% endif %}

        <div class="control-group">
            <label for="notifications" class="control-label">
                <strong>{% trans 'Notifications' %}</strong>
            </label>
            <div class="controls">
                <label class="checkbox inline">
                    {% input_class report_form.subscription 'conditions_check' %}
                    {% trans "J'accepte de recevoir des notifications par emails m'informant de l'évolution de l'incident" %}
                </label>
            </div>
        </div>

        {% if not BACKOFFICE %}

            <div class="control-group">
                <label for="conditions" class="control-label">
                    <strong>{% trans 'Conditions' %}</strong>
                </label>
                <div class="controls">
                    <label class="checkbox inline">
                        {% input_class report_form.terms_of_use_validated 'conditions_check' %}
                        {% trans "J'ai lu et accepté les conditions d'utilisations (+ lien)" %}
                    </label>
                </div>
            </div>

        {% endif %}

        <div id="required-note" >{% trans "* This fields are required" %}</div>

        <div class="warning_information_form">
            <p class="info_end_form">{% trans "Un email contenant le rapport vous sera envoyé juste après l'envoi." %}</p>
            <button id="validate_button" class="btn pull-right" disabled> {% trans 'Send' %}</button>
        </div>
        <p><button id="previousStep">Etape précédente</button></p>

    </div>

</form>

<div id="nonparticipatingcommune" class="modal hide fade" role="dialog" style="z-index: 200000">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>{% trans "Warning" %}!</h3>
    </div>
    <div class="modal-body">
        <p>{% trans "Does not participate to FixMyStreet yet with details"%} <span id="phone"></span></p>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true"> {% trans "Close dialog" %}</button>
    </div>
</div>

{% endblock %}
