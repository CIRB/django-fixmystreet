{% extends "base.html" %}
{% load i18n tags %}
{% block title %}{% trans "New Report" %}{% endblock %}
{% block script %}
{{ block.super }}

<script src="{{ STATIC_URL }}js/attachmentForms.js"></script>
<script src="{{ STATIC_URL }}js/categorySelection.js"></script>

<meta property="og:title" content="{% trans 'New Report' %}" />
<meta property="og:description" content="{% trans 'Signalez tout type d incident. Sur FixMyStreet qui identifiera alors le service public en charge de le traiter.' %}" />
<script>
$(function(){
	var $form = $('#report_form');

	fms.currentMap = new fms.Map('map', {
		apiLang:     LANGUAGE_CODE,
		localizeUrl: GEOSERVER_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
		urbisUrl:    GEOSERVER_URL + '/geoserver/wms',
		origin:{
			x:{{ pnt.x }},
			y:{{ pnt.y }}
		}
	});
	{% for report in reports %}
	fms.currentMap.addReport({{ report.to_JSON|dict_to_json|safe }},{{forloop.counter}});
	{% endfor %}
	fms.currentMap.addDraggableMarker({{ pnt.x }}, {{ pnt.y }});
});

</script>
<script src="{{STATIC_URL}}js/new_report.js"></script>

<script>
$(document).delegate("form", "submit", function(evt) {
        {% if not BACKOFFICE %}
		if ($('#available_zipcodes option[value="'+$('#id_postalcode').val()+'"]').length == 0) {
                	//This commune does not participate to fixmystreet until now.
                	alert("{% trans 'This_commune_does_not_participate' %}: "+$('#available_zipcodes_as_string').html());
                	return false;
        	}
		{% endif %}
});

</script>



{% block specific_scripts %}
<script src="{{STATIC_URL}}js/reportFormReview.js"></script>
{% endblock %}
{% endblock %}

{% block content %}
    <article id="map">
        <div id="cursor-instructions" class="block highlighted">
            {% trans "Drag me to change my location." %}
        </div>
    </article>
    <h1>{% trans "Submitting a report" %}</h1>

	<div id="leftcol">
		{% block report_form %}
		<form enctype="multipart/form-data" method="post" action="" id='report_form' style="display:none;">
            <h2>
                {% trans "Fill the report" %}
            </h2>
			<table id="new_report_citizen_form" class="form">
				<tr>
					<th></th>
					<td id="required_note">{% trans "* This fields are required" %}</td>
				</tr>
				{{ report_form.as_table }}
				<tr>
					<td></td>
					<td><div id='secondary_container'></div></td>
				</tr>
				<tr>
					<td>
						<select id="available_zipcodes" style="display:none">
	 			{% for zip in available_zips %}
							<option value="{{zip.code}}">
							</option>
                		{% endfor %}
						</select>
                			<span id="available_zipcodes_as_string" style="display:none">
	 				{% for zip in available_zips %}
						{{zip.code}}/{{zip.name}}
					{% endfor %}
					</span>
					</td>
				</tr>

			</table>
			<div id="report_overview_table_div">
			<table class="report_overview_table">
				<tr>
					<th>{% trans 'Location' %}</th>
					<td id="locationView">

					</td>
				</tr>
				<tr>
					<th>{% trans 'Category' %}</th>
					<td id="category1View">

					</td>
				</tr>
				<tr>
					<th>{% trans 'Category' %}</th>
					<td id="category2View">

					</td>
				</tr>
				<!--<tr>
					<th>{% trans 'Photo' %}</th>
					<td id="photoView">

					</td>
				</tr>-->
				<tr>
					<th>{% trans 'Description' %}</th>
					<td id="descriptionView">

					</td>
				</tr>
				<tr>
					<th>{% trans 'Email' %}</th>
					<td id="emailView">

					</td>
				</tr>
				<tr>
					<th>{% trans 'First name' %}</th>
					<td id="firstNameView">

					</td>
				</tr>
				<tr>
					<th>{% trans 'Name' %}</th>
					<td id="nameView">

					</td>
				</tr>
			</table>
			<p>
                <input type="button" class='big_button' value="{% trans 'Edit' %}" style="float:left;" onclick="showForm();"/>
            </p>
			</div>
            <input type="submit" class='big_button' value="{% trans 'Submit' %}" />
		</form>
		{% endblock %}
		<div id="addAnnexes">
		<div style="padding-top:30px">
        	<div id="extraFilesDiv">
            <h3>{% trans "Extra files" %}</h3>

                <table id="extraFilesTable" style='width:100%;'>

            	</table>
            </div>
            <div id="extraCommentsDiv">
            <h3>{% trans "Extra comments" %}</h3>

                <table class="extraCommentsTable" style='width:100%;'>

            	</table>
            </div>
        </div>

     </div>
     <!-- If the status allow such interactions -->
		{% if report.status.code != '3' and report.status.code != '8' and report.status.code != '9'  %}
		<div id="addCommmentDiv">
			<h2>{% trans "Add a comment to this report" %}</h2>
			<input id="showCommentFormButton" type="button" class="big_button" onclick="toggleCommentForm();" value="Add"/>

			<form id="commentForm" enctype="multipart/form-data"  method="post">
				<table id="report_form" class="form">
					<tr>
						<th>{% trans 'Text'%}:</th>
						<td><textarea id="commentTextTextArea"></textarea></td>
					</tr>
					<tr>
						<td></td>
						<td>
							<p style="float:left;">
								<input type="button" class='big_button' value="{% trans 'Add' %}" onclick="AddCommentToView('{{LANGUAGE_CODE}}');toggleCommentForm();"/>
								<input type="button" class='big_button' value="{% trans 'Cancel' %}" onclick="toggleCommentForm();"/>
							</p>
						</td>
					</tr>
				</table>
			</form>
		</div>
        	<div id="addFileDiv">
        		<h2>{% trans "Add a file to this report" %}</h2>

        		<input id="showFileFormButton" type="button" class="big_button" onclick="toggleFileForm();" value="Add"/>
        		<form id="fileForm" enctype="multipart/form-data" action="{% url report_upload_file %}" method="post">
        			<table id="report_form" class="form">
        				{{ file_upload_Form.as_table }}
        				<tr>
        					<td></td>
        					<td>
        						<p style="float:left;">
        							<input type="button" class='big_button' value="{% trans 'Add' %}" onclick="checkFileFieldValue();AddFileToView('{{LANGUAGE_CODE}}');setTimeout('toggleFileForm()',200);"/>
        							<input type="button" class='big_button' value="{% trans 'Cancel' %}" onclick="toggleFileForm();"/>
        						</p>
        					</td>
        				</tr>
        			</table>
        		</form>
        	</div>
		{% endif %}
	</div>
	<div id="rightcol">
        <p>{% trans "Zoom out to see more reports nearby." %}</p>
        <div class='note'>
            <p><strong>{% trans "Please Note" %} :</strong></p>
            <ul>
                <li>{% trans "Please be polite, concise and to the point." %}</li>
                <li>{% trans "Please do not be abusive - abusing the service devalues the service for all users." %}</li>
                <li>{% trans "Writing your message entirely in block capitals makes it hard to read, as does a lack of punctuation." %}</li>
                <li>{% trans "Remember that FixMyStreet is primarily for reporting physical problems that can be fixed. If your problem is not appropriate for submission via this site please contact city officials directly." %}</li>
            </ul>
            <p/>
        </div>
        <h2>
            {% trans "Nearby reports" %}
        </h2>

        {% if reports %}
            <div id='search_results'>
            {% for report in reports %}
            {% include "reports/_navigation.html" with url=report.get_absolute_url %}
            {% endfor %}
            </div>
        {% else %}
            <p>{% trans "No problems have been reported in this area." %}</p>
        {% endif %}
    </div>





	</div>
</div>
{% endblock %}
