{% extends "base.html" %}
{% load i18n %}
{% load tags %}
{% block title %}{% trans "Reports for" %} {{entity.name}}{% endblock %}
{% block css %}
{{ block.super }}

{% endblock %}

{% block script %}
{{ block.super }}

<meta property="og:title" content="{% trans 'Reports for' %} {{entity.name}}" />
<meta property="og:description" content="{% trans 'Meta description for list page' %}" />
<script>
$(function(){
    defaultX = 148838.00741428943
    defaultY = 171086.0720425099

    {% if reports.0 %}
        defaultX = {{reports.0.point.x}}
        defaultY = {{reports.0.point.y}}
    {% endif %}


    // $('#map-bxl').fmsMap();
 //    $('#map-bxl').fmsMap('highlightArea', '{{ entity.feature_id }}');

    // {% for report in reports %}
    // $('#map-bxl').fmsMap('addReport',  {{ report.to_JSON|dict_to_json|safe }}, {{ forloop.counter }});
    // {% endfor %}

    // $('#map-bxl').bind('reportselected',function(evt, point, report){
    //     window.location.assign('{{report.get_absolute_url}}');
    // });

    fms.currentMap = new fms.Map('map', {
        apiLang:     LANGUAGE_CODE,
        localizeUrl: URBIS_URL + '/service/urbis/Rest/Localize/getaddressfromxy',
        urbisUrl:    URBIS_URL + '/geoserver/wms',
        origin:{
            x: defaultX,
            y: defaultY
        }
    });
    {% for report in reports %}
            fms.currentMap.addReport({{ report.to_JSON|dict_to_json|safe }}, {{forloop.counter}}, {% if BACKOFFICE %}true{%else%}false{%endif%});
    {% endfor %}
    // Add the active class to the active page number
    $("#page_{{request.GET.page}}").addClass("active");
    // Set the state of the arrow buttons (active or inactive)
    if("{{request.GET.page}}"=="1"){
        $(".pagination_prev").removeClass("active");
    }
    else{
        $(".pagination_prev").addClass("active");
    }
    if("{{pages_list|last}}"=="{{request.GET.page}}"){
        $(".pagination_next").removeClass("active");
    }
    else{
        $(".pagination_next").addClass("active");
    }
    //Add onclick event for arrows
    $(".pagination_next.active").bind("click",function(){
        getUrlForPageNumber(parseInt("{{request.GET.page}}")+1);
    });
    $(".pagination_prev.active").bind("click",function(){
        getUrlForPageNumber(parseInt("{{request.GET.page}}")-1);
    });
});

/**
 * Method called when searching report per ticket number.
 */
function search_per_ticket() {
        searchValue = $('#input-search').val();
    //Block to search per ticket number
    if (searchValue && searchValue.length > 0) {
        valToSearch = searchValue;
        //On this page character # is not required as the search zone is dedicated.
        if (searchValue[0] == "#")
            valToSearch = searchValue.substring(1);
        window.location = "/report/search_ticket?report_id="+valToSearch;
    }
}

function getUrlForPageNumber(number) {
    var url = "{{request.get_full_path}}";
    if(url.indexOf("page=")!=-1){
        var list = url.split("page=");
        url1= list[0].replace(/\&amp;/g,'&');
        url1 = url1.replace("amp;","");
        url = url1 + "page="+ number;
    }
    else {
        url += "?page="+number;
    }

    window.location= url;
}
</script>
{% endblock %}

{% block map %}
<article id="map"></article>
{% endblock %}

{% block content %}
<div class="row">
    <div id="incident_filter" class="span12">
        <ul>
            <li>
                    <img src="{{STATIC_URL}}images/pin-red-L.png"> <span>{% trans 'Unpublished' %}</span>
            </li>
            <li>
                    <img src="{{STATIC_URL}}images/pin-orange-L.png"> <span>{% trans 'In progress' %}</span>
            </li>
            <li>
                    <img src="{{STATIC_URL}}images/pin-green-L.png"> <span>{% trans 'Closed' %}</span>
            </li>
        </ul>
    </div>

    <h1 class="span12">{% trans "Reports for" %} {{entity.name}}</h1>
    <div id="nearby-reports">
        {% if not reports %}
            <div class='span6'>{% trans "No problems have been reported." %}</div>
        {% else %}
            <div id="search_results" class='span6'>
                {% for report in reports %}
                    {% include "reports/_navigation.html" with url=report.get_absolute_url %}
                {% endfor %}

                <div class="pagination pagination-centered">
                    <ul>
                        <li><a class="pagination_prev"></a></li>
                        {% for number in pages_list %}
                            <li id="page_{{number}}" ><a href="javascript:getUrlForPageNumber({{number}});">{{number}}</a></li>
                        {% endfor %}
                        <li><a class="pagination_next"></a></li>
                    </ul>
                </div>
            </div>
        {% endif %}
    </div>

    <div class='span6'>
        <div id="search_by_ticket_nr">
            <p >{% trans "Search by entering a ticket number:" %}</p>
            <input id="input-search" class="input_search_ticket" type="search" name="search_ticket" placeholder="{% trans 'Insert your ticket number here' %}" />
            <p style="float:right">
                <input type="button" onclick="javascript:search_per_ticket()" class='btn' value="{% trans 'Search' %}" />
            </p>
        </div>
        <div id="go_to_submit_report">
            <input type="button" class='btn' value="{% trans 'Report an incident' %}" onclick="window.location.href='/'"/>
        </div>
   </div>
</div>
{% endblock %}
